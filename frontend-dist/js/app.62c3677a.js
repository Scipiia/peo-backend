(function(){"use strict";var e={7610:function(e,l,t){var a=t(5130),n=t(6768),o=t.p+"img/logo_pasport_new.62978c94.jpg";const u={id:"app"},r={class:"navbar no-print"},s={class:"nav-container"},i={class:"nav-menu"},d={class:"nav-item"},p={class:"nav-item"},c={class:"nav-item"},v={class:"main-content"};function m(e,l,t,a,m,k){const y=(0,n.g2)("router-link"),L=(0,n.g2)("router-view");return(0,n.uX)(),(0,n.CE)("div",u,[(0,n.Lk)("nav",r,[(0,n.Lk)("div",s,[l[3]||(l[3]=(0,n.Lk)("div",{class:"nav-logo"},[(0,n.Lk)("img",{src:o,alt:"Логотип NormApp",class:"logo-img"}),(0,n.Lk)("span")],-1)),(0,n.Lk)("ul",i,[(0,n.Lk)("li",d,[(0,n.bF)(y,{to:"/orders",class:"nav-link"},{default:(0,n.k6)(()=>l[0]||(l[0]=[(0,n.eW)("Заказы из ДЕМ")])),_:1,__:[0]})]),(0,n.Lk)("li",p,[(0,n.bF)(y,{to:"/norm/orders/",class:"nav-link"},{default:(0,n.k6)(()=>l[1]||(l[1]=[(0,n.eW)("Нормированные наряды")])),_:1,__:[1]})]),(0,n.Lk)("li",c,[(0,n.bF)(y,{to:"/final/orders/",class:"nav-link"},{default:(0,n.k6)(()=>l[2]||(l[2]=[(0,n.eW)("Отчёты для ПЭО")])),_:1,__:[2]})])])])]),(0,n.Lk)("main",v,[(0,n.bF)(L)])])}var k={name:"App"},y=t(1241);const L=(0,y.A)(k,[["render",m]]);var _=L,b=t(1387),h=(t(4114),t(4232)),f=t(144),g=t(4373);const C={class:"orders-page"},w={class:"filters"},F=["value"],E={key:0,class:"table-container"},x=["onClick"],X={key:1,class:"error"},z={key:2,class:"no-orders"};var V={__name:"OrdersList",setup(e){const l=(0,b.rd)(),t=(0,f.KR)([]),o=(0,f.KR)(""),u=(0,f.KR)((new Date).getFullYear()),r=(0,f.KR)((new Date).getMonth()+1),s=(0,f.KR)(""),i=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];async function d(){try{t.value=[],o.value="";const e={};s.value?e.search=s.value:(e.year=u.value,e.month=r.value);const l=await g.A.get("/api/orders",{params:e});l.data.error?o.value=l.data.error:t.value=l.data.orders}catch(e){o.value="Не удалось загрузить заказы.",console.error(e)}}function p(e){l.push({name:"OrdersDetails",params:{id:e}})}return(0,n.sV)(()=>{d()}),(0,n.wB)([u,r,s],()=>{d()}),(e,l)=>((0,n.uX)(),(0,n.CE)("div",C,[l[7]||(l[7]=(0,n.Lk)("h1",null,"Заказы",-1)),(0,n.Lk)("div",w,[(0,n.Lk)("div",null,[l[3]||(l[3]=(0,n.Lk)("label",null,"Год:",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>u.value=e),type:"number",min:"2020",max:"2030"},null,512),[[a.Jo,u.value,void 0,{number:!0}]])]),(0,n.Lk)("div",null,[l[4]||(l[4]=(0,n.Lk)("label",null,"Месяц:",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[1]||(l[1]=e=>r.value=e)},[((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(i,(e,l)=>(0,n.Lk)("option",{key:l+1,value:l+1},(0,h.v_)(e),9,F)),64))],512),[[a.u1,r.value]])]),(0,n.Lk)("div",null,[l[5]||(l[5]=(0,n.Lk)("label",null,"Поиск:",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[2]||(l[2]=e=>s.value=e),placeholder:"Поиск по номеру..."},null,512),[[a.Jo,s.value]])])]),t.value&&t.value.length>0?((0,n.uX)(),(0,n.CE)("div",E,[(0,n.Lk)("table",null,[l[6]||(l[6]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Заказ"),(0,n.Lk)("th",null,"Заказчик"),(0,n.Lk)("th",null,"Примечание")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id,onClick:l=>p(e.id),style:{cursor:"pointer"}},[(0,n.Lk)("td",null,(0,h.v_)(e.order_num),1),(0,n.Lk)("td",null,(0,h.v_)(e.customer),1),(0,n.Lk)("td",null,(0,h.v_)(e.ms_note),1)],8,x))),128))])])])):o.value?((0,n.uX)(),(0,n.CE)("div",X,(0,h.v_)(o.value),1)):((0,n.uX)(),(0,n.CE)("div",z,"Заказы не найдены"))]))}};const U=(0,y.A)(V,[["__scopeId","data-v-03c809d4"]]);var K=U;t(8111),t(2489),t(116),t(7588),t(1701),t(8237),t(4603),t(7566),t(8721);const I={class:"form-container"},q={class:"card-info"},R={key:0,class:"image-preview-container"},$=["src"],S=["src"],W={class:"composite-toggle"},J={key:1,class:"parent-selection"},T=["value"],O={key:0,class:"text-muted"},N={class:"parent-selection"},A={class:"forms-section"},D={class:"category-title"},j={class:"templates-list"},P=["onClick"],Q={key:2,class:"full-form"},H={class:"part-type-badge"},M={key:0},G={class:"norm-table"},B=["value","onInput"],Y=["value","disabled","onInput"],Z={class:"text-center"},ee={class:"custom-operations-input"},le={class:"norm-table"},te=["onUpdate:modelValue"],ae=["onUpdate:modelValue"],ne={class:"text-center"},oe=["onClick"],ue={class:"total-summary"},re={key:0,class:"calculation-info"},se={key:0},ie={class:"form-actions"},de=["disabled"],pe=["disabled"];var ce={__name:"FormSendPeo",setup(e){const l=(0,b.lq)(),t=`orderDetail_${l.params.id}_${l.query.position}`,o=(0,f.KR)({order_num:"Неизвестно",name:"Неизвестно",count:0,color:"Не указан",image:"",customer:"Не указан",sqr:0,position:""});(0,n.sV)(()=>{const e=sessionStorage.getItem(t);if(e){const l=JSON.parse(e);return void(o.value={...l})}const a={order_num:l.query.order_num||"Неизвестно",name:l.query.name||"Неизвестно",count:parseInt(l.query.count)||1,color:l.query.color||"Не указан",customer:l.query.customer||"Не указан",sqr:parseFloat(l.query.sqr)||0,position:l.query.position||"",image:l.query.image||""};sessionStorage.setItem(t,JSON.stringify(a)),o.value=a;const n={...l.query};delete n.image,window.history.replaceState({},"",`${location.pathname}?${new URLSearchParams(n).toString()}`)});const u=(0,f.KR)([]),r=(0,f.KR)(null),s=(0,f.KR)(!1),i=(0,f.KR)(!1),d=(0,f.KR)(!1),p=(0,f.KR)(null),c=(0,f.KR)([]),v=(0,f.KR)(null),m=(0,f.KR)(null),k=(0,f.KR)(!1),y=(0,f.KR)(""),L=(0,f.KR)(""),_={window:"Окна",glyhar:"Глухари",loggia:"Лоджии",vitrage:"Витражи",door:"Двери"};(0,n.wB)(d,async e=>{if(e&&o.value.order_num)try{const e=await fetch(`/api/orders/order-norm/by-order?order_num=${o.value.order_num}`);if(e.ok){const l=await e.json();c.value=l.filter(e=>"main"===e.part_type)}else c.value=[]}catch(l){console.error("Ошибка загрузки родителей:",l),c.value=[]}else p.value=null});const g=(0,n.EW)(()=>{const e={},l=Object.keys(_);return l.forEach(l=>{e[l]=[]}),u.value?.Template?.forEach(t=>{const a=t.category?.toLowerCase().trim();l.includes(a)&&e[a].push(t)}),Object.keys(e).forEach(l=>{0===e[l].length&&delete e[l]}),e});(0,n.sV)(async()=>{try{const e=await fetch("/api/all_templates");if(!e.ok)throw new Error("Не удалось загрузить шаблоны");u.value=await e.json()}catch(e){console.error("Ошибка загрузки шаблонов:",e),alert("Не удалось загрузить шаблоны. Проверьте подключение.")}});const C=(0,n.EW)(()=>{const e=r.value?.operations?.reduce((e,l)=>"number"===typeof l.dynamicValue?e+l.dynamicValue:e,0)||0,l=K.value.reduce((e,l)=>{if(!l.name?.trim())return e;const t=l.minutes/60||0;return e+t},0);return(e+l).toFixed(3)}),w=(0,n.EW)(()=>Math.round(60*parseFloat(C.value)));function F(e,l){const t=parseFloat(l);if(isNaN(t))return;const a=r.value.operations[e];a.dynamicValue=t,a.count>0?a.rate=t/a.count:a.rate=t,a.minutes=Number(60*a.dynamicValue).toFixed(1)}function E(e,l){const t=parseFloat(l);if(isNaN(t))return;const a=r.value.operations[e];a.count=t;const n=a.group;if(!n)return a.dynamicValue=t*a.rate,void(a.minutes=parseFloat((60*a.dynamicValue).toFixed(1)));const o=r.value.operations.filter(e=>e.group===n);o.forEach(e=>{e.count=t,e.dynamicValue=t*e.rate,e.minutes=parseFloat((60*e.dynamicValue).toFixed(1))})}function x(){const e=parseInt(o.value?.count)||1;r.value?.operations&&r.value.operations.forEach(l=>{if(l.group&&["ign"].includes(l.group))return void(l.count=1);const t=l.count;l.count=t*e,l.dynamicValue=l.count*l.rate,l.minutes=parseFloat((60*l.dynamicValue).toFixed(1))})}async function X(e){s.value=!0;try{const l=await fetch(`/api/template?code=${e.code}`);if(!l.ok)throw new Error("Не удалось загрузить форму");r.value=await l.json(),r.value.type=e.category,r.value.code=e.code,d.value&&p.value?(r.value.part_type="sub",r.value.parent_product_id=p.value):(r.value.part_type="main",r.value.parent_product_id=null),r.value.operations=r.value.operations.map(e=>({...e,count:e.count??0,baseValue:e.value??0,rate:e.value??0,dynamicValue:(e.count??0)*(e.value??0)}));const t={};r.value.operations.forEach(e=>{e.group&&(t[e.group]=t[e.group]||[],t[e.group].push(e))}),r.value.operationsByGroup=t,m.value=e.code}catch(l){console.error("Ошибка загрузки формы:",l),alert("Не удалось загрузить форму. Попробуйте снова.")}finally{s.value=!1}}function z(){const e=r.value.operations.filter(e=>"number"===typeof e.dynamicValue&&e.dynamicValue>0).map(e=>({operation_name:e.name,operation_label:e.label,count:parseFloat(e.count),value:parseFloat(e.dynamicValue.toFixed(3)),minutes:parseFloat(e.minutes)})),l=me.value.map(e=>({operation_name:e.operation_name,operation_label:e.operation_label,count:e.count,value:parseFloat(e.value.toFixed(3)),minutes:e.minutes})),t=[...e,...l],a=t.reduce((e,l)=>e+l.value,0),n={order_num:o.value.order_num,name:o.value.name,template_code:r.value.code,count:o.value.count,type:r.value.type,part_type:r.value.part_type,parent_product_id:r.value.parent_product_id,parent_assembly:y.value,total_time:parseFloat(a.toFixed(3)),position:parseInt(o.value.position),customer:o.value.customer,operations:t,status:"in_production",systema:r.value.systema,type_izd:L.value||r.value.type_izd,profile:r.value.profile,sqr:parseFloat(o.value.sqr)};fetch("/api/orders/order-norm/template",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>e.json()).then(e=>{if(!e.order_id)return void console.warn("Ошибка: не получен ID наряда",e.order_id);let l;"main"===r.value.part_type?(l=e.order_id,v.value=l):(l=v.value,l||(console.warn("lastRootId не установлен, используем текущий ID"),l=e.order_id));const t=confirm(`Нормировка "${r.value.name}" сохранена!\n\nХотите добавить ещё одну часть?`);if(t)r.value=null;else{const l="main"===r.value.part_type?e.order_id:v.value||e.order_id;Ya.push(`/norm/order-norm/print/${l}`),i.value=!0}}).catch(e=>{console.error("Ошибка сохранения:",e),alert("Не удалось сохранить нормировку")})}const V=(0,f.KR)(null);async function U(){if(r.value&&o.value.order_num&&o.value.position){s.value=!0;try{const e=r.value.type,l=await fetch("/api/materials/calculation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_num:o.value.order_num,position:parseInt(o.value.position),type:e,template:r.value.code})});if(!l.ok){const e=await l.text();throw new Error(`Ошибка расчёта: ${l.status} — ${e}`)}const t=await l.json();V.value=t.context;const a=r.value.operations.map(e=>{const l=t.operation.find(l=>l.name===e.name);return l?{...e,count:l.count??e.count,dynamicValue:l.value??e.dynamicValue,minutes:l.minutes??e.minutes}:e});a.forEach(e=>{e.count>0?e.rate=e.dynamicValue/e.count:e.rate=e.dynamicValue}),r.value.operations=a;const n=a.reduce((e,l)=>e+l.dynamicValue,0);r.value.total_time=parseFloat(n.toFixed(3))}catch(e){console.error("Ошибка автоматического расчёта:",e),alert(`Не удалось рассчитать нормы: ${e.message}`)}finally{s.value=!1}}else alert("Недостаточно данных для расчёта")}const K=(0,f.KR)([{name:"",minutes:0,count:1}]);function ce(){K.value.push({name:"",minutes:0,count:1})}function ve(e){K.value.length<=1?K.value[e]={name:"",minutes:0,count:1}:K.value.splice(e,1)}const me=(0,n.EW)(()=>K.value.filter(e=>e.name.trim()).map(e=>{const l=parseFloat(e.minutes)||0,t=l/60;return{operation_name:`custom_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,operation_label:e.name.trim(),count:1,value:parseFloat(t.toFixed(3)),minutes:parseFloat(l.toFixed(3))}}));return(e,l)=>((0,n.uX)(),(0,n.CE)("div",I,[(0,n.Lk)("h2",null,"Форма нормировки — изделие «"+(0,h.v_)(o.value.name)+"»",1),(0,n.Lk)("div",q,[(0,n.Lk)("p",null,[l[9]||(l[9]=(0,n.Lk)("strong",null,"Номер заказа:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.order_num),1)]),(0,n.Lk)("p",null,[l[10]||(l[10]=(0,n.Lk)("strong",null,"Позиция:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.position),1)]),(0,n.Lk)("p",null,[l[11]||(l[11]=(0,n.Lk)("strong",null,"Количество:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.count),1)]),(0,n.Lk)("p",null,[l[12]||(l[12]=(0,n.Lk)("strong",null,"Цвет:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.color),1)]),(0,n.Lk)("p",null,[l[13]||(l[13]=(0,n.Lk)("strong",null,"Заказчик:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.customer),1)]),(0,n.Lk)("p",null,[l[14]||(l[14]=(0,n.Lk)("strong",null,"Площадь:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value.sqr)+" м²",1)]),o.value.image?((0,n.uX)(),(0,n.CE)("div",R,[(0,n.Lk)("img",{src:`data:image/png;base64,${o.value.image}`,alt:"Изображение заказа",class:"order-image clickable",onClick:l[0]||(l[0]=e=>k.value=!0),title:"Нажмите, чтобы увеличить"},null,8,$)])):(0,n.Q3)("",!0)]),k.value?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"image-modal",onClick:l[3]||(l[3]=e=>k.value=!1)},[(0,n.Lk)("div",{class:"modal-content",onClick:l[2]||(l[2]=(0,a.D$)(()=>{},["stop"]))},[(0,n.Lk)("img",{src:`data:image/png;base64,${o.value.image}`,alt:"Увеличенное изображение",class:"enlarged-image"},null,8,S),(0,n.Lk)("button",{class:"close-btn",onClick:l[1]||(l[1]=e=>k.value=!1)},"×")])])):(0,n.Q3)("",!0),(0,n.Lk)("div",W,[(0,n.Lk)("label",null,[(0,n.bo)((0,n.Lk)("input",{type:"checkbox","onUpdate:modelValue":l[4]||(l[4]=e=>d.value=e)},null,512),[[a.lH,d.value]]),l[15]||(l[15]=(0,n.eW)(" Это составная часть (витраж к двери(двери с глухарем) и тп) "))])]),d.value?((0,n.uX)(),(0,n.CE)("div",J,[l[21]||(l[21]=(0,n.Lk)("label",null,[(0,n.Lk)("strong",null,"Привязать к:")],-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[5]||(l[5]=e=>p.value=e),class:"form-control",required:""},[l[16]||(l[16]=(0,n.Lk)("option",{value:"",disabled:""},"Выберите основное изделие...",-1)),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(c.value,e=>((0,n.uX)(),(0,n.CE)("option",{key:e.id,value:e.id},(0,h.v_)(e.name),9,T))),128))],512),[[a.u1,p.value]]),0===c.value.length?((0,n.uX)(),(0,n.CE)("p",O," Нет доступных основных изделий. Сначала добавьте основное (дверь, окно и т.п.). ")):(0,n.Q3)("",!0),(0,n.Lk)("div",N,[l[19]||(l[19]=(0,n.Lk)("label",{class:"form-control"},[(0,n.Lk)("strong",null,"Уточнение для части:")],-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[6]||(l[6]=e=>y.value=e),class:"form-custom-select"},l[17]||(l[17]=[(0,n.Lk)("option",{value:""},"— выберите —",-1),(0,n.Lk)("option",{value:"с глухарем"},"с глухарем",-1)]),512),[[a.u1,y.value]]),l[20]||(l[20]=(0,n.Lk)("label",{class:"form-control"},[(0,n.Lk)("strong",null,"Наименование:")],-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[7]||(l[7]=e=>L.value=e),class:"form-custom-select"},l[18]||(l[18]=[(0,n.Lk)("option",{value:""},"— выберите —",-1),(0,n.Lk)("option",{value:"витраж к двери"},"витраж к двери",-1)]),512),[[a.u1,L.value]])])])):(0,n.Q3)("",!0),(0,n.Lk)("div",A,[l[22]||(l[22]=(0,n.Lk)("h4",null,"Выберите тип изделия",-1)),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(g.value,(e,l)=>((0,n.uX)(),(0,n.CE)("div",{key:l,class:"category-group"},[(0,n.Lk)("h5",D,(0,h.v_)(_[l]),1),(0,n.Lk)("ul",j,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e,e=>((0,n.uX)(),(0,n.CE)("li",{key:e.code,onClick:l=>X(e),class:(0,h.C4)(["template-item",{selected:m.value===e.code}])},(0,h.v_)(e.name),11,P))),128))])]))),128))]),r.value?((0,n.uX)(),(0,n.CE)("div",Q,[(0,n.Lk)("h3",null,(0,h.v_)(r.value.name),1),(0,n.Lk)("div",H,[l[23]||(l[23]=(0,n.eW)(" Тип: ")),(0,n.Lk)("strong",null,(0,h.v_)("main"===r.value.part_type?"Основное изделие":"Составная часть"),1),r.value.parent_product_id?((0,n.uX)(),(0,n.CE)("span",M," (привязано к наряду ID="+(0,h.v_)(r.value.parent_product_id)+") ",1)):(0,n.Q3)("",!0)]),(0,n.Lk)("table",G,[l[24]||(l[24]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Операция"),(0,n.Lk)("th",null,"Норма (ч)"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Норма (мин)")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(r.value.operations,(e,l)=>((0,n.uX)(),(0,n.CE)("tr",{key:e.name},[(0,n.Lk)("td",null,(0,h.v_)(e.label),1),(0,n.Lk)("td",null,[(0,n.Lk)("input",{type:"number",step:"0.01",min:"0",value:e.dynamicValue,class:"input-small",onInput:e=>F(l,e.target.value)},null,40,B)]),(0,n.Lk)("td",null,[(0,n.Lk)("input",{type:"number",step:"1",min:"0",value:e.count,class:"input-small",disabled:"ign"===e.group,onInput:e=>E(l,e.target.value)},null,40,Y)]),(0,n.Lk)("td",Z,(0,h.v_)(e.minutes),1)]))),128))])]),(0,n.Lk)("div",ee,[l[26]||(l[26]=(0,n.Lk)("h4",null,"Дополнительные операции",-1)),(0,n.Lk)("table",le,[l[25]||(l[25]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Название операции"),(0,n.Lk)("th",null,"Норма(мин)"),(0,n.Lk)("th",null,"Норма(ч)"),(0,n.Lk)("th",{style:{width:"40px"}})])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(K.value,(e,l)=>((0,n.uX)(),(0,n.CE)("tr",{key:l},[(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.name=l,type:"text",placeholder:"Название",class:"input-small wide"},null,8,te),[[a.Jo,e.name]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.minutes=l,type:"number",step:"0.001",min:"0",class:"input-small"},null,8,ae),[[a.Jo,e.minutes,void 0,{number:!0}]])]),(0,n.Lk)("td",ne,(0,h.v_)(((e.minutes||0)/60).toFixed(3)),1),(0,n.Lk)("td",null,[K.value.length>1?((0,n.uX)(),(0,n.CE)("button",{key:0,type:"button",class:"btn-remove",onClick:e=>ve(l),title:"Удалить"}," − ",8,oe)):(0,n.Q3)("",!0)])]))),128))])]),(0,n.Lk)("button",{type:"button",class:"btn-add-row",onClick:ce}," + Добавить ещё операцию ")]),(0,n.Lk)("div",ue,[l[27]||(l[27]=(0,n.Lk)("strong",null,"Итоговое время:",-1)),(0,n.eW)(" "+(0,h.v_)(C.value)+" ч ("+(0,h.v_)(w.value)+" мин) ",1)]),V.value?((0,n.uX)(),(0,n.CE)("div",re,[(0,n.Lk)("small",null,"Импостов в материалах найдено: "+(0,h.v_)(V.value.ImpostCount),1),(0,n.Lk)("small",null,"Створок меньше 400мм в материалах найдено: "+(0,h.v_)(V.value.StvTCount400),1),(0,n.Lk)("small",null,"Створок меньше 615мм в материалах найдено: "+(0,h.v_)(V.value.StvTCount600),1),V.value.HasStublina?((0,n.uX)(),(0,n.CE)("div",se,l[28]||(l[28]=[(0,n.Lk)("small",null,"В материалах найдена накладка на цилиндр Stublina",-1)]))):(0,n.Q3)("",!0)])):(0,n.Q3)("",!0),(0,n.Lk)("div",ie,[(0,n.Lk)("button",{type:"button",class:"multiply-count-btn",onClick:l[8]||(l[8]=e=>x())}," Умножить на кол-во изделий ("+(0,h.v_)(o.value.count)+") ",1),(0,n.Lk)("button",{type:"button",onClick:U,disabled:!m.value||s.value,class:"btn-recalculate"}," Рассчитать нормы по материалам ",8,de),(0,n.Lk)("button",{onClick:z,disabled:s.value,class:"btn-save"},(0,h.v_)(s.value?"Сохраняем...":"Сохранить нормировку"),9,pe)])])):(0,n.Q3)("",!0)]))}};const ve=(0,y.A)(ce,[["__scopeId","data-v-547dc89c"]]);var me=ve;const ke={key:0},ye={key:1,class:"error"},Le={key:2},_e={class:"plans-container"},be=["onClick"],he=["src"],fe={class:"plan-details"},ge={key:3};var Ce={__name:"OrdersDetails",setup(e){const l=(0,b.lq)(),t=(0,b.rd)(),a=(0,f.KR)(!0),o=(0,f.KR)(null),u=(0,f.KR)(null),r=l.params.id;async function s(){try{const e=await g.A.get(`/api/orders/order/${r}`);u.value=e.data}catch(e){console.error("Ошибка при получении деталей заказа:",e),o.value="Не удалось загрузить детали заказа."}finally{a.value=!1}}function i(){t.go(-1)}function d(e){const l={order_num:u.value.order_num,name:e.name_position,count:e.count,color:e.color,customer:u.value.customer,sqr:e.sqr,image:e.image,position:e.position},a=`orderDetail_${u.value.id}_${e.position}`;sessionStorage.setItem(a,JSON.stringify(l)),t.push({name:"FormPagePeo",params:{id:e.plan_id},query:{position:e.position,fromStorage:"true"}})}return(0,n.sV)(()=>{s()}),(e,l)=>((0,n.uX)(),(0,n.CE)("div",null,[l[9]||(l[9]=(0,n.Lk)("h2",null,"Детали коммерческого приложения",-1)),a.value?((0,n.uX)(),(0,n.CE)("div",ke,l[0]||(l[0]=[(0,n.Lk)("p",null,"Loading...",-1)]))):o.value?((0,n.uX)(),(0,n.CE)("div",ye,[(0,n.Lk)("p",null,(0,h.v_)(o.value),1)])):u.value?((0,n.uX)(),(0,n.CE)("div",Le,[(0,n.Lk)("p",null,[l[1]||(l[1]=(0,n.Lk)("strong",null,"Номер заказа:",-1)),(0,n.eW)(" "+(0,h.v_)(u.value.order_num),1)]),(0,n.Lk)("div",null,[l[7]||(l[7]=(0,n.Lk)("h1",null,"Изделия",-1)),(0,n.Lk)("div",_e,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.value.order_dem_price,(e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,onClick:l=>d(e),class:"plan-item"},[(0,n.Lk)("img",{src:`data:image/png;base64,${e.image}`,width:"120",alt:"Order Image"},null,8,he),(0,n.Lk)("div",fe,[(0,n.Lk)("p",null,[l[2]||(l[2]=(0,n.Lk)("strong",null,"Позиция:",-1)),(0,n.eW)(" "+(0,h.v_)(e.position),1)]),(0,n.Lk)("p",null,[l[3]||(l[3]=(0,n.Lk)("strong",null,"Название:",-1)),(0,n.eW)(" "+(0,h.v_)(e.name_position),1)]),(0,n.Lk)("p",null,[l[4]||(l[4]=(0,n.Lk)("strong",null,"Количество:",-1)),(0,n.eW)(" "+(0,h.v_)(e.count),1)]),(0,n.Lk)("p",null,[l[5]||(l[5]=(0,n.Lk)("strong",null,"Цвет:",-1)),(0,n.eW)(" "+(0,h.v_)(e.color),1)]),(0,n.Lk)("p",null,[l[6]||(l[6]=(0,n.Lk)("strong",null,"Площадь:",-1)),(0,n.eW)(" "+(0,h.v_)(e.sqr),1)])])],8,be))),128))])]),(0,n.Lk)("button",{onClick:i},"Назад")])):((0,n.uX)(),(0,n.CE)("div",ge,l[8]||(l[8]=[(0,n.Lk)("p",null,"Детали заказа не найдены",-1)])))]))}};const we=(0,y.A)(Ce,[["__scopeId","data-v-1b317e1d"]]);var Fe=we;const Ee={class:"additional-ops"},xe={class:"operations-table"};function Xe(e,l){return(0,n.uX)(),(0,n.CE)("div",Ee,[l[3]||(l[3]=(0,n.Lk)("h3",{class:"additional-ops-label"},[(0,n.Lk)("label",null,"Доп работы")],-1)),(0,n.Lk)("table",xe,[l[2]||(l[2]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",{width:"40%"},"Операция"),(0,n.Lk)("th",{width:"10%"},"Норма н/час"),(0,n.Lk)("th",{width:"10%"},"Норма н/мин"),(0,n.Lk)("th",null,"ФИО исполнителя")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(3,e=>(0,n.Lk)("tr",{key:e},l[0]||(l[0]=[(0,n.Lk)("td",null," ",-1),(0,n.Lk)("td",null," ",-1),(0,n.Lk)("td",null," ",-1),(0,n.Lk)("td",null," ",-1)]))),64)),l[1]||(l[1]=(0,n.Lk)("tr",{class:"total-row"},[(0,n.Lk)("td",{colspan:"3",class:"text-right"},[(0,n.Lk)("strong",null,"Итого доп. работ:")]),(0,n.Lk)("td")],-1))])])])}const ze={},Ve=(0,y.A)(ze,[["render",Xe],["__scopeId","data-v-cb0b450e"]]);var Ue=Ve;const Ke={class:"print-container"},Ie={key:0,class:"print-layout"},qe={class:"print-page main-page"},Re={class:"header"},$e={class:"operations-table"},Se={class:"total-row"},We={class:"header"},Je={class:"operations-table"},Te={class:"total-row"},Oe={class:"print-controls"},Ne=["disabled"],Ae={key:1,class:"loading"},De={key:2,class:"error"};var je={__name:"PrintNormOrder",setup(e){const l=(0,b.lq)(),t=(0,f.KR)(null),a=(0,f.KR)(!0);(0,n.sV)(async()=>{const e=l.params.id;if(e)try{const l=await fetch(`/api/orders/order-norm/${e}`);if(!l.ok)throw new Error(`Ошибка загрузки элемента: ${l.status}`);const a=await l.json(),n=Array.isArray(a)?a[0]:a;let o;o="main"===n.part_type?e:n.parent_product_id?n.parent_product_id:e;const u=await fetch(`/api/orders/order-norm/${o}`);if(!u.ok)throw new Error(`Не удалось загрузить сборку: ${u.status}`);const r=await u.json();let s;if(Array.isArray(r))s=r;else{if(!r||"object"!==typeof r)throw new Error("Некорректные данные");s=[r]}const i=s.find(e=>"main"===e.part_type),d=s.filter(e=>"sub"===e.part_type),p=i||(s.length>0?s[0]:null);if(!p)throw new Error("Нет данных для отображения");t.value={main:p,subs:d}}catch(n){console.error("Ошибка загрузки:",n)}finally{a.value=!1}else alert("Не указан ID")});const o=(0,f.KR)(!1),u=()=>{r(t.value.main)},r=async e=>{if(e){o.value=!0;try{const l=await g.A.post("/api/orders/cancel",{root_product_id:e.id});if(200!==l.status)throw new Error("API вернул неожиданный статус");e.status="cancel",alert("Заказ успешно отменён.")}catch(l){console.error("Ошибка при отмене заказа:",l);let e="Не удалось отменить заказ.";l.response?.data?.message&&(e+="\n"+l.response.data.message),alert(e)}finally{o.value=!1}}};function s(){const e=document.querySelector(".print-layout");if(!e)return void alert("Нет данных для печати");const l=e.cloneNode(!0),t=l.querySelector(".print-controls");t&&t.remove();const a=l.innerHTML,n=`\n    <!DOCTYPE html>\n    <html>\n      <head>\n        <meta charset="utf-8">\n        <title>Технологический процесс</title>\n        <style>\n          body {\n            font-family: 'Segoe UI', Arial, sans-serif;\n            font-size: 13px;\n            line-height: 1.4;\n            padding: 15px;\n            margin: 0;\n            color: #000;\n            background: #fff;\n            -webkit-print-color-adjust: exact;\n            print-color-adjust: exact;\n            width: 210mm;\n            margin: 0 auto;\n          }\n          .print-page {\n            break-inside: avoid;\n            page-break-inside: avoid;\n            margin-bottom: 12px;\n          }\n          .header p {\n            margin: 2px 0;\n            line-height: 1.2;\n          }\n          table {\n            width: 100%;\n            border-collapse: collapse;\n            margin: 4px 0;\n            font-size: 12px;\n          }\n          th, td {\n            border: 1px solid #000;\n            padding: 4px 6px;\n            text-align: left;\n          }\n          th {\n            background-color: #f2f2f2;\n            font-weight: bold;\n          }\n          .total-row {\n            background-color: #f9f9f9;\n            font-weight: bold;\n          }\n          .additional-ops {\n            margin-top: 6px;\n            break-inside: avoid;\n            page-break-inside: avoid;\n          }\n          @media print {\n            @page {\n              margin: 1cm;\n              size: A4 portrait;\n            }\n            body {\n              -webkit-print-color-adjust: exact;\n            }\n          }\n        </style>\n      </head>\n      <body onload="window.focus(); window.print();">\n        <div class="print-container">\n          ${a}\n        </div>\n      </body>\n    </html>\n  `,o=window.open("","_blank","width=1000,height=800");o.document.write(n),o.document.close()}return(e,l)=>((0,n.uX)(),(0,n.CE)("div",Ke,[t.value?((0,n.uX)(),(0,n.CE)("div",Ie,[(0,n.Lk)("div",qe,[(0,n.Lk)("div",Re,[(0,n.Lk)("p",null,"Пооперационный технологический процесс "+(0,h.v_)(t.value.main.head_name),1),(0,n.Lk)("p",null,[l[0]||(l[0]=(0,n.Lk)("strong",null,"Номер заказа:",-1)),(0,n.eW)(" "+(0,h.v_)(t.value.main.order_num),1)]),(0,n.Lk)("p",null,[l[1]||(l[1]=(0,n.Lk)("strong",null,"Количество:",-1)),(0,n.eW)(" "+(0,h.v_)(t.value.main.count),1)]),(0,n.Lk)("table",$e,[l[4]||(l[4]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",{width:"40%"},"Операция"),(0,n.Lk)("th",{width:"10%"},[(0,n.eW)("Итого "),(0,n.Lk)("br"),(0,n.eW)(" н/час")]),(0,n.Lk)("th",{width:"10%"},[(0,n.eW)("Итого "),(0,n.Lk)("br"),(0,n.eW)(" н/мин")]),(0,n.Lk)("th",null,"ФИО исполнителя")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.value.main.operations,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.operation_name},[(0,n.Lk)("td",null,(0,h.v_)(e.operation_label),1),(0,n.Lk)("td",null,(0,h.v_)(e.value.toFixed(3)),1),(0,n.Lk)("td",null,(0,h.v_)(e.minutes),1),l[2]||(l[2]=(0,n.Lk)("td",null,null,-1))]))),128)),(0,n.Lk)("tr",Se,[l[3]||(l[3]=(0,n.Lk)("td",{colspan:"1",class:"text-right"},[(0,n.Lk)("strong",null,"Итого:")],-1)),(0,n.Lk)("td",null,(0,h.v_)(t.value.main.total_time.toFixed(3)),1),(0,n.Lk)("td",null,(0,h.v_)(Math.round(60*t.value.main.total_time)),1)])])]),(0,n.bF)(Ue)])]),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.value.subs,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"print-page sub-page"},[(0,n.Lk)("div",We,[(0,n.Lk)("p",null,"Пооперационный технологический процесс "+(0,h.v_)(e.head_name),1),(0,n.Lk)("p",null,[l[5]||(l[5]=(0,n.Lk)("strong",null,"Номер заказа:",-1)),(0,n.eW)(" "+(0,h.v_)(e.order_num),1)]),(0,n.Lk)("p",null,[l[6]||(l[6]=(0,n.Lk)("strong",null,"Количество:",-1)),(0,n.eW)(" "+(0,h.v_)(e.count),1)]),(0,n.Lk)("table",Je,[l[9]||(l[9]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",{width:"40%"},"Операция"),(0,n.Lk)("th",{width:"10%"},[(0,n.eW)("Итого "),(0,n.Lk)("br"),(0,n.eW)(" н/час")]),(0,n.Lk)("th",{width:"10%"},[(0,n.eW)("Итого "),(0,n.Lk)("br"),(0,n.eW)(" н/мин")]),(0,n.Lk)("th",null,"ФИО исполнителя")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.operations,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.operation_name},[(0,n.Lk)("td",null,(0,h.v_)(e.operation_label),1),(0,n.Lk)("td",null,(0,h.v_)(e.value.toFixed(3)),1),(0,n.Lk)("td",null,(0,h.v_)(e.minutes),1),l[7]||(l[7]=(0,n.Lk)("td",null,null,-1))]))),128)),(0,n.Lk)("tr",Te,[l[8]||(l[8]=(0,n.Lk)("td",{colspan:"1",class:"text-right"},[(0,n.Lk)("strong",null,"Итого:")],-1)),(0,n.Lk)("td",null,(0,h.v_)(e.total_time.toFixed(3)),1),(0,n.Lk)("td",null,(0,h.v_)(Math.round(60*e.total_time)),1)])])]),(0,n.bF)(Ue)])]))),128)),(0,n.Lk)("div",Oe,[(0,n.Lk)("button",{onClick:s,class:"btn-print"},"Распечатать"),t.value.main&&"cancel"!==t.value.main.status?((0,n.uX)(),(0,n.CE)("button",{key:0,onClick:u,class:"btn-cancel",disabled:o.value},(0,h.v_)(o.value?"Отменяем...":"Отменить заказ"),9,Ne)):(0,n.Q3)("",!0)])])):a.value?((0,n.uX)(),(0,n.CE)("div",Ae," Загрузка сборки... ")):((0,n.uX)(),(0,n.CE)("div",De," Не удалось загрузить данные. "))]))}};const Pe=(0,y.A)(je,[["__scopeId","data-v-d25065c0"]]);var Qe=Pe;const He={class:"orders-page"},Me={class:"filters"},Ge={class:"filter-group"},Be={class:"filter-group"},Ye={key:0,class:"orders-table"},Ze={class:"text-center"},el={class:"text-right"},ll=["onClick"],tl=["onClick"],al=["onClick"],nl={key:1,class:"no-results"},ol={key:2,class:"loading"};var ul={__name:"NormOrdersList",setup(e){const l=(0,b.rd)(),t=(0,f.KR)({order_num:"",type:""}),o=(0,f.KR)([]),u=(0,f.KR)(!1),r={window:"Окно",glyhar:"Глухарь",door:"Дверь",loggia:"Лоджия",vitrage:"Витраж",other:"Другое"},s={assigned:"Сотрудники назначены",in_production:"В производстве",final:"Готов для ПЭО",cancel:"Отменён"},i=e=>r[e]||e,d=e=>s[e]||e,p=()=>{c()},c=async()=>{u.value=!0;const e=new URLSearchParams;t.value.order_num&&e.append("order_num",t.value.order_num),t.value.type&&e.append("type",t.value.type);try{const l=await fetch(`/api/orders/order/norm/all?${e}`);if(!l.ok)return console.error("Ошибка HTTP:",l.status),void(o.value=[]);const t=await l.json();o.value=Array.isArray(t)?t:[]}catch(l){console.error("Ошибка сети:",l),o.value=[]}finally{u.value=!1}},v=e=>{l.push(`/norm/orders/order-norm/edit/${e.id}`)},m=e=>{l.push({name:"AssignWorkers",params:{id:e.id}})},k=async e=>{try{const l=await g.A.post("/api/orders/cancel",{root_product_id:e.id});200===l.status&&(e.status="cancel")}catch(l){console.error("Ошибка при отмене заказа:",l)}};return(0,n.sV)(()=>{const e=new URLSearchParams(window.location.search);e.has("order_num")&&(t.value.order_num=e.get("order_num")),e.has("type")&&(t.value.type=e.get("type")),c()}),(e,l)=>((0,n.uX)(),(0,n.CE)("div",He,[l[6]||(l[6]=(0,n.Lk)("h2",null,"Нормированные заказы",-1)),(0,n.Lk)("div",Me,[(0,n.Lk)("div",Ge,[l[2]||(l[2]=(0,n.Lk)("label",null,"Номер заказа",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>t.value.order_num=e),type:"text",placeholder:"",onInput:p},null,544),[[a.Jo,t.value.order_num]])]),(0,n.Lk)("div",Be,[l[4]||(l[4]=(0,n.Lk)("label",null,"Тип изделия",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[1]||(l[1]=e=>t.value.type=e),onChange:p},l[3]||(l[3]=[(0,n.Fv)('<option value="" data-v-0e4fe694>Все типы</option><option value="window" data-v-0e4fe694>Окна</option><option value="glyhar" data-v-0e4fe694>Глухари</option><option value="door" data-v-0e4fe694>Двери</option><option value="loggia" data-v-0e4fe694>Лоджии</option><option value="vitrage" data-v-0e4fe694>Витражи</option>',6)]),544),[[a.u1,t.value.type]])])]),o.value.length>0?((0,n.uX)(),(0,n.CE)("table",Ye,[l[5]||(l[5]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Заказ"),(0,n.Lk)("th",null,"Изделие"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Тип"),(0,n.Lk)("th",null,"Время (ч)"),(0,n.Lk)("th",null,"Дата"),(0,n.Lk)("th",null,"Действие"),(0,n.Lk)("th",null,"Статус")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id},[(0,n.Lk)("td",null,(0,h.v_)(e.order_num),1),(0,n.Lk)("td",null,(0,h.v_)(e.name),1),(0,n.Lk)("td",Ze,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,[(0,n.Lk)("span",{class:(0,h.C4)(`type-badge type-${e.type}`)},(0,h.v_)(i(e.type)),3)]),(0,n.Lk)("td",el,(0,h.v_)(e.total_time.toFixed(3)),1),(0,n.Lk)("td",null,(0,h.v_)(new Date(e.created_at).toLocaleDateString()),1),(0,n.Lk)("td",null,[(0,n.Lk)("button",{onClick:l=>v(e),class:"btn-view"}," Просмотр ",8,ll),(0,n.Lk)("button",{onClick:l=>m(e),class:"btn-view"}," Назначить сотрудников ",8,tl),"cancel"!==e.status?((0,n.uX)(),(0,n.CE)("button",{key:0,onClick:l=>k(e),class:"btn-view"}," Отменить ",8,al)):(0,n.Q3)("",!0)]),(0,n.Lk)("td",null,[(0,n.Lk)("span",{class:(0,h.C4)(`status-badge type-${e.status}`)},(0,h.v_)(d(e.status)),3)])]))),128))])])):u.value?((0,n.uX)(),(0,n.CE)("div",ol,"Загрузка...")):((0,n.uX)(),(0,n.CE)("div",nl,(0,h.v_)(t.value.order_num||t.value.type?"Нет заказов по фильтру":"Нет нормированных заказов"),1))]))}};const rl=(0,y.A)(ul,[["__scopeId","data-v-0e4fe694"]]);var sl=rl;const il={key:0,class:"edit-norm-page"},dl={class:"item-info"},pl={class:"operations-table"},cl=["onUpdate:modelValue","onInput"],vl=["onUpdate:modelValue"],ml=["onUpdate:modelValue"],kl=["onUpdate:modelValue","onChange","disabled"],yl=["onUpdate:modelValue"],Ll=["onUpdate:modelValue","onInput","disabled"],_l=["onUpdate:modelValue","disabled"],bl=["onUpdate:modelValue","disabled"],hl={class:"actions"},fl=["disabled"],gl={key:1,class:"loading"},Cl={key:2,class:"error"};var wl={__name:"EditNormOrder",setup(e){const l=(0,b.lq)(),t=(0,b.rd)(),o=(0,f.KR)([]),u=(0,f.KR)(!1);(0,n.sV)(()=>{s()});const r=e=>{"допвремя на напиловку"===e.operation_label?e.operation_name="dop_nap":"доп время на сборку"===e.operation_label?e.operation_name="dop_sbor":e.operation_name=""},s=async()=>{u.value=!0;try{const e=l.params.id;if(!e)return console.error("Не указан ID наряда"),t.push("/norm/orders/");const a=await fetch(`/api/orders/order-norm/${e}`);if(!a.ok)throw new Error("Наряд не найден");const n=await a.json();let u;u="main"===n.part_type?e:n.parent_product_id?n.parent_product_id:e;const r=await fetch(`/api/orders/order-norm/${u}`);if(!r.ok)throw new Error("Не удалось загрузить сборку");const s=await r.json();o.value=s.map(e=>({id:e.id,order_num:e.order_num,name:e.name,count:e.count,type:e.type,type_izd:e.type_izd,part_type:e.part_type,parent_product_id:e.parent_product_id,created_at:e.created_at,operations:e.operations.map(e=>({...e})),extraOperations:[{operation_name:"dop_nap",operation_label:"",count:0,value:0,minutes:0,fixed:!0},{operation_name:"dop_sbor",operation_label:"",count:0,value:0,minutes:0,fixed:!0},{operation_name:"",operation_label:"",count:0,value:0,minutes:0,fixed:!1},{operation_name:"",operation_label:"",count:0,value:0,minutes:0,fixed:!1}]}))}catch(e){console.error("Ошибка загрузки:",e),alert("Не удалось загрузить данные. Проверьте соединение."),t.push("/norm/orders/")}finally{u.value=!1}},i=e=>"main"===e.part_type?`Основное изделие: ${e.name}`:`Составная часть: ${e.name}`,d=e=>{if(!e)return"";const l=new Date(e);return l.toLocaleDateString("ru-RU")},p=e=>{void 0!==e.value&&(e.minutes=(60*e.value).toFixed(1))},c=e=>{"number"!==typeof e.value||isNaN(e.value)||(e.minutes=parseFloat((60*e.value).toFixed(1)))},v=async()=>{if(u.value)return;u.value=!0;const e=o.value.map(async e=>{const l=e.extraOperations.filter(e=>""!==e.operation_label.trim()),t=[...e.operations,...l].reduce((e,l)=>e+l.value,0),a={order_num:e.order_num,product_name:e.name,type:e.type,status:"in_production",total_time:parseFloat(t.toFixed(3)),operations:[...e.operations.map(e=>({operation_name:e.operation_name,operation_label:e.operation_label,count:parseInt(e.count)||0,value:parseFloat(e.value)||0,minutes:parseFloat(e.minutes)||0})),...l.map(e=>({operation_name:e.operation_name,operation_label:e.operation_label,count:parseInt(e.count)||0,value:parseFloat(e.value)||0,minutes:parseFloat(e.minutes)||0}))]};try{const l=await fetch(`/api/orders/order/norm/update/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return l.ok?{success:!0,id:e.id}:{success:!1,id:e.id}}catch(n){return console.error(`Ошибка при сохранении наряда ${e.id}:`,n),{success:!1,id:e.id}}}),l=await Promise.all(e),t=l.filter(e=>e.success).length;t===l.length||(t>0?console.error(`Сохранено ${t} из ${l.length} нарядов. Проверьте данные.`):console.error("Не удалось сохранить ни один наряд")),await s(),u.value=!1};function m(){const e=l.params.id;window.location.href=`/norm/order-norm/print/${e}`}const k=()=>{t.push("/norm/orders/")};return(e,l)=>!u.value&&o.value?((0,n.uX)(),(0,n.CE)("div",il,[l[6]||(l[6]=(0,n.Lk)("h2",null,"Редактирование заказа",-1)),(0,n.Lk)("p",null,[l[0]||(l[0]=(0,n.Lk)("strong",null,"Заказ:",-1)),(0,n.eW)(" "+(0,h.v_)(o.value[0]?.order_num),1)]),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.value,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"assembly-item"},[(0,n.Lk)("h3",null,(0,h.v_)(i(e)),1),(0,n.Lk)("div",dl,[(0,n.Lk)("span",null,[l[1]||(l[1]=(0,n.Lk)("strong",null,"Тип:",-1)),(0,n.eW)(" "+(0,h.v_)(e.type_izd),1)]),(0,n.Lk)("span",null,[l[2]||(l[2]=(0,n.Lk)("strong",null,"Кол-во:",-1)),(0,n.eW)(" "+(0,h.v_)(e.count),1)]),(0,n.Lk)("span",null,[l[3]||(l[3]=(0,n.Lk)("strong",null,"Создан:",-1)),(0,n.eW)(" "+(0,h.v_)(d(e.created_at)),1)])]),(0,n.Lk)("table",pl,[l[5]||(l[5]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Операция"),(0,n.Lk)("th",null,"Время (ч)"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Время (мин)")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.operations,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.operation_name},[(0,n.Lk)("td",null,(0,h.v_)(e.operation_label),1),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.value=l,type:"number",min:"0",step:"0.01",class:"input-small",onInput:l=>p(e)},null,40,cl),[[a.Jo,e.value,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.count=l,type:"number",step:"1",min:"0",class:"input-small"},null,8,vl),[[a.Jo,e.count,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.minutes=l,type:"number",min:"0",class:"input-small"},null,8,ml),[[a.Jo,e.minutes,void 0,{number:!0}]])])]))),128)),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.extraOperations,(e,t)=>((0,n.uX)(),(0,n.CE)("tr",{key:e.operation_name||`custom_${t}`},[(0,n.Lk)("td",null,[e.fixed?(0,n.bo)(((0,n.uX)(),(0,n.CE)("select",{key:0,"onUpdate:modelValue":l=>e.operation_label=l,class:"input-full",onChange:l=>r(e),disabled:u.value},l[4]||(l[4]=[(0,n.Lk)("option",{value:""},"-- Выберите операцию --",-1),(0,n.Lk)("option",{value:"доп время на напиловку"},"доп время на напиловку",-1),(0,n.Lk)("option",{value:"доп время на сборку"},"доп время на сборку",-1)]),40,kl)),[[a.u1,e.operation_label]]):(0,n.bo)(((0,n.uX)(),(0,n.CE)("input",{key:1,"onUpdate:modelValue":l=>e.operation_label=l,type:"text",placeholder:"Введите название операции",class:"input-full"},null,8,yl)),[[a.Jo,e.operation_label]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.value=l,type:"number",min:"0",step:"0.01",class:"input-small",onInput:l=>c(e),disabled:u.value},null,40,Ll),[[a.Jo,e.value,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.count=l,type:"number",step:"1",min:"0",class:"input-small",disabled:u.value},null,8,_l),[[a.Jo,e.count,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.minutes=l,type:"number",min:"0",class:"input-small",disabled:u.value},null,8,bl),[[a.Jo,e.minutes,void 0,{number:!0}]])])]))),128))])])]))),128)),(0,n.Lk)("div",hl,[(0,n.Lk)("button",{onClick:k,class:"btn-cancel"},"Назад"),(0,n.Lk)("button",{onClick:v,disabled:u.value,class:"btn-save"},(0,h.v_)(u.value?"Сохраняем...":"Сохранить всё"),9,fl),(0,n.Lk)("button",{onClick:m,class:"btn-print"}," Перейти к печати ")])])):u.value?((0,n.uX)(),(0,n.CE)("div",gl,"Загрузка сборки...")):((0,n.uX)(),(0,n.CE)("div",Cl,"Не удалось загрузить данные"))}};const Fl=(0,y.A)(wl,[["__scopeId","data-v-f595018a"]]);var El=Fl;t(1148),t(3579);const xl={key:0,class:"assign-workers"},Xl={class:"info-grid"},zl={class:"total-time"},Vl={class:"total-time"},Ul={class:"executors-table"},Kl={class:"text-center"},Il={class:"text-center"},ql=["onUpdate:modelValue"],Rl=["value","disabled"],$l=["onUpdate:modelValue","onInput"],Sl=["onUpdate:modelValue","onInput"],Wl=["onClick"],Jl=["onClick"],Tl={class:"actions"},Ol=["disabled"],Nl={key:1,class:"loading"},Al={key:2,class:"error"};var Dl={__name:"AssignWorkers",setup(e){const l=(0,b.lq)(),t=(0,b.rd)(),o=(0,f.KR)(null),u=(0,f.KR)([]),r=(0,f.KR)(!1),s=(0,f.KR)(""),i=(e,l,t)=>e.some(e=>e!==t&&e.employee_id===l);(0,n.sV)(async()=>{const e=l.params.id;if(!e)return;r.value=!0;try{const l=await fetch(`/api/orders/order-norm/${e}`);if(!l.ok)throw new Error("Не удалось загрузить сборку");const t=await l.json(),a=t.map(e=>({...e,operations:e.operations.map(e=>{const l=Array.isArray(e.assign_workers)&&e.assign_workers.length>0?e.assign_workers.map(e=>({employee_id:e.employee_id,actual_minutes:e.actual_minutes,actual_value:parseFloat(e.actual_value.toFixed(3))})):[{employee_id:"",actual_minutes:e.minutes,actual_value:parseFloat(e.value.toFixed(3))}];return{...e,executors:l}})})),n=a.find(e=>"main"===e.part_type)||a[0],u=a.filter(e=>"sub"===e.part_type);o.value={main:n,subs:u}}catch(i){console.error("Ошибка загрузки:",i),alert("Не удалось загрузить данные")}finally{r.value=!1}const t=(new Date).toISOString().split("T")[0],a=o.value.main.ready_date;let n=t;if(a){const e=new Date(a).toISOString().split("T")[0];"Invalid date"!==e&&(n=e)}s.value=n;try{const e=await fetch("/api/workers/all");u.value=await e.json()}catch(i){console.error("Ошибка загрузки сотрудников:",i)}});const d=(0,n.EW)(()=>o.value?[o.value.main,...o.value.subs]:[]),p=(0,n.EW)(()=>d.value.reduce((e,l)=>e+l.total_time,0)),c=e=>e?new Date(e).toLocaleDateString("ru-RU"):"",v=e=>"main"===e.part_type?`${e.name}`:`${e.name} (часть изделия)`,m=e=>{const l={window:"Окно",glyhar:"Глухарь",door:"Дверь",loggia:"Лоджия",vitrage:"Витраж"};return l[e]||e},k=e=>{const l=Number(e.actual_minutes);e.actual_value=isNaN(l)?0:parseFloat((l/60).toFixed(3))},y=e=>{const l=Number(e.actual_value);e.actual_minutes=isNaN(l)?0:Number((60*l).toFixed(3))},L=e=>{const l=e.value,t=e.executors.length+1,a=parseFloat((l/t).toFixed(3));e.executors.push({employee_id:"",actual_minutes:Number(parseFloat((60*a).toFixed(3))),actual_value:a}),g(e)},_=(e,l)=>{e.executors.length<=1||(e.executors.splice(l,1),g(e))},g=e=>{const l=e.value,t=e.executors.length;if(0===t)return;const a=parseFloat((l/t).toFixed(3));e.executors.forEach(e=>{e.actual_minutes=Number(parseFloat((60*a).toFixed(3))),e.actual_value=a})},C=async()=>{const e={assignments:[],update_status:"assigned",root_product_id:o.value.main.id,ready_date:s.value},l=[];for(const t of d.value)for(const a of t.operations){const n=a.executors.filter(e=>e.employee_id);if(0!==n.length)for(const o of a.executors)o.employee_id||l.push(`У операции "${a.operation_label}" (${t.name}) указан исполнитель без ФИО`),o.employee_id&&e.assignments.push({product_id:t.id,operation_name:a.operation_name,employee_id:o.employee_id,actual_minutes:o.actual_minutes||a.minutes,actual_value:o.actual_value||a.value,notes:""});else l.push(`Операция "${a.operation_label}" (${t.name}) — не назначен исполнитель`)}if(l.length>0)alert("Не все операции назначены:\n\n"+l.join("\n"));else if(0!==e.assignments.length)try{const l=await fetch("/api/workers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});l.ok&&t.push("/norm/orders")}catch(a){console.error("Ошибка отправки:",a)}else alert("Нет ни одной операции с назначением")},w=()=>{t.back()};return(e,l)=>o.value?((0,n.uX)(),(0,n.CE)("div",xl,[l[11]||(l[11]=(0,n.Lk)("h2",null,"Назначение работников",-1)),(0,n.Lk)("div",Xl,[l[2]||(l[2]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Заказ:")],-1)),(0,n.Lk)("div",null,(0,h.v_)(o.value.main.order_num),1),l[3]||(l[3]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Изделие:")],-1)),(0,n.Lk)("div",null,(0,h.v_)(o.value.main.name),1),l[4]||(l[4]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Общее время:")],-1)),(0,n.Lk)("div",zl,(0,h.v_)(p.value.toFixed(3))+" ч ("+(0,h.v_)(Math.round(60*p.value))+" мин) ",1),l[5]||(l[5]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Дата создания:")],-1)),(0,n.Lk)("div",null,(0,h.v_)(c(o.value.main.created_at)),1),l[6]||(l[6]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Дата выполнения:")],-1)),(0,n.Lk)("div",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>s.value=e),type:"date",class:"input-date"},null,512),[[a.Jo,s.value]]),l[1]||(l[1]=(0,n.Lk)("small",null,"Укажите дату изготовления",-1))])]),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(d.value,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"item-section"},[(0,n.Lk)("h3",null,(0,h.v_)(v(e)),1),(0,n.Lk)("p",null,[l[7]||(l[7]=(0,n.Lk)("strong",null,"Тип:",-1)),(0,n.eW)(" "+(0,h.v_)(m(e.type)),1)]),l[10]||(l[10]=(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,"Общее время:")],-1)),(0,n.Lk)("div",Vl,(0,h.v_)(e.total_time.toFixed(3))+" ч ("+(0,h.v_)(Math.round(60*e.total_time))+" мин) ",1),(0,n.Lk)("table",Ul,[l[9]||(l[9]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Операция"),(0,n.Lk)("th",null,"Норма (мин)"),(0,n.Lk)("th",null,"Норма (ч)"),(0,n.Lk)("th",{style:{width:"50%"}},[(0,n.eW)(" Исполнители "),(0,n.Lk)("div",{class:"executor-headers"},[(0,n.Lk)("span",{class:"header-label"},"Исполнитель"),(0,n.Lk)("span",{class:"header-label"},"Факт (мин)"),(0,n.Lk)("span",{class:"header-label"},"Факт (ч)")])])])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.operations,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.operation_name,class:(0,h.C4)({"missing-executor":e.executors.every(e=>!e.employee_id)})},[(0,n.Lk)("td",null,(0,h.v_)(e.operation_label),1),(0,n.Lk)("td",Kl,(0,h.v_)(e.minutes),1),(0,n.Lk)("td",Il,(0,h.v_)(e.value.toFixed(3)),1),(0,n.Lk)("td",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.executors,(t,o)=>((0,n.uX)(),(0,n.CE)("div",{key:o,class:"executor-row"},[(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":e=>t.employee_id=e,class:"select-employee"},[l[8]||(l[8]=(0,n.Lk)("option",{value:""},"— выберите —",-1)),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.value,l=>((0,n.uX)(),(0,n.CE)("option",{key:l.id,value:l.id,disabled:i(e.executors,l.id,t)},(0,h.v_)(l.name),9,Rl))),128))],8,ql),[[a.u1,t.employee_id]]),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":e=>t.actual_minutes=e,type:"number",placeholder:"мин",class:"input-minutes",min:"0",step:"0.001",onInput:e=>k(t)},null,40,$l),[[a.Jo,t.actual_minutes,void 0,{number:!0}]]),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":e=>t.actual_value=e,type:"number",placeholder:"ч",class:"input-minutes",min:"0",step:"0.01",onInput:e=>y(t)},null,40,Sl),[[a.Jo,t.actual_value,void 0,{number:!0}]]),e.executors.length>1?((0,n.uX)(),(0,n.CE)("button",{key:0,type:"button",onClick:l=>_(e,o),class:"btn-remove"}," ✕ ",8,Wl)):(0,n.Q3)("",!0)]))),128)),(0,n.Lk)("button",{type:"button",onClick:l=>L(e),class:"btn-add"}," + Добавить исполнителя ",8,Jl)])],2))),128))])])]))),128)),(0,n.Lk)("div",Tl,[(0,n.Lk)("button",{onClick:w,class:"btn-cancel"},"Назад"),(0,n.Lk)("button",{onClick:C,disabled:r.value,class:"btn-save"},(0,h.v_)(r.value?"Сохраняем...":"Сохранить назначения"),9,Ol)])])):r.value?((0,n.uX)(),(0,n.CE)("div",Nl,"Загрузка сборки...")):((0,n.uX)(),(0,n.CE)("div",Al,"Не удалось загрузить данные"))}};const jl=(0,y.A)(Dl,[["__scopeId","data-v-65d3bb60"]]);var Pl=jl,Ql=(t(7642),t(8004),t(3853),t(5876),t(2475),t(5024),t(1698),t(7093)),Hl=t.n(Ql);const Ml={class:"form-group"},Gl=["value"],Bl={key:2,class:"error-text"},Yl=["value"],Zl={key:0,class:"error-text"},et=["value"],lt={key:0,class:"error-text"},tt=["value"],at={key:0,class:"error-text"},nt={key:0,class:"error-text"},ot=["value"],ut={key:0,class:"error-text"},rt={key:0,class:"error-text"},st=["value"],it={key:0,class:"error-text"},dt={class:"modal-actions"},pt=["disabled"];var ct={__name:"EditProductModal",props:{product:Object,employees:Array},emits:["close","cancel"],setup(e,{emit:l}){const t=e,o=l,u=(0,f.KR)({...t.product}),r=[{value:"к",label:"корпоративный"},{value:"ч",label:"частный"},{value:"д",label:"дилер"}],s=["1П","1Пт","1.5П","1.5Пт","2П","2Пт"],i=[{value:"сх",label:"Сиал холодный"},{value:"ст",label:"Сиал теплый"},{value:"ах",label:"Алютех холодный"},{value:"ат",label:"Алютех теплый"},{value:"щ",label:"Шуко"}],d=[{value:"х",label:"Холодная"},{value:"т",label:"Тёплая"}],p=(0,n.EW)(()=>"door"===u.value.type),c=["бригада","бригада окон, дверей","бригада витражей"],v=(0,f.KR)({}),m=()=>{v.value={};const e=[{key:"type_izd",label:"Наименование"},{key:"systema",label:"Система"},{key:"profile",label:"Профиль"},{key:"sqr",label:"Площадь"},{key:"brigade",label:"Бригада"},{key:"norm_money",label:"Н/руб"},{key:"customer_type",label:"Направление заказчика"},{key:"coefficient",label:"Коэффициент"}];return e.forEach(e=>{const l=u.value[e.key];l&&("string"!==typeof l||l.trim())||(v.value[e.key]=!0)}),(isNaN(parseFloat(u.value.sqr))||parseFloat(u.value.sqr)<0)&&(v.value.sqr=!0),(isNaN(parseFloat(u.value.norm_money))||parseFloat(u.value.norm_money)<0)&&(v.value.norm_money=!0),0===Object.keys(v.value).length},k=(0,n.EW)(()=>m()),y=()=>{m()&&o("close",u.value)},L=(0,f.KR)(!1),_=()=>{if(L.value)return;const e=parseFloat(u.value.total_time),l=parseFloat(u.value.coefficient);isNaN(e)||isNaN(l)||(u.value.norm_money=parseFloat((e*l).toFixed(3)))};(0,n.wB)(()=>u.value.coefficient,()=>{L.value||_()});const b=()=>{L.value=!1},g=e=>{L.value=!0,u.value.norm_money=parseFloat(e.target.value)||0},C=()=>{if(u.value.norm_money&&u.value.norm_money>0)return;const e=parseFloat(u.value.total_time),l=parseFloat(u.value.coefficient);console.log("SASAS",e),!isNaN(e)&&!isNaN(l)&&l>0&&(u.value.norm_money=parseFloat((e*l).toFixed(3)),L.value=!1)};C();const w=()=>{o("cancel")};return(e,l)=>((0,n.uX)(),(0,n.CE)("div",{class:"modal-overlay",onClick:w},[(0,n.Lk)("div",{class:"modal-content",onClick:l[9]||(l[9]=(0,a.D$)(()=>{},["stop"]))},[l[24]||(l[24]=(0,n.Lk)("h3",null,"Редактирование изделия",-1)),(0,n.Lk)("div",Ml,[l[10]||(l[10]=(0,n.Lk)("label",null,"Спецификация",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>u.value.parent_assembly=e),class:"form-input",placeholder:"Опционально"},null,512),[[a.Jo,u.value.parent_assembly]])]),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.type_izd}])},[l[12]||(l[12]=(0,n.Lk)("label",null,"Наименование",-1)),p.value?(0,n.bo)(((0,n.uX)(),(0,n.CE)("select",{key:0,"onUpdate:modelValue":l[1]||(l[1]=e=>u.value.type_izd=e),class:(0,h.C4)(["form-select",{invalid:v.value.type_izd}]),onChange:m},[l[11]||(l[11]=(0,n.Lk)("option",{value:"",disabled:""},"Выберите тип двери",-1)),((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(s,e=>(0,n.Lk)("option",{key:e,value:e},(0,h.v_)(e),9,Gl)),64))],34)),[[a.u1,u.value.type_izd]]):(0,n.bo)(((0,n.uX)(),(0,n.CE)("input",{key:1,"onUpdate:modelValue":l[2]||(l[2]=e=>u.value.type_izd=e),class:(0,h.C4)(["form-input",{invalid:v.value.type_izd}]),onBlur:m},null,34)),[[a.Jo,u.value.type_izd]]),v.value.type_izd?((0,n.uX)(),(0,n.CE)("span",Bl,"Укажите наименование")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.customer_type}])},[l[14]||(l[14]=(0,n.Lk)("label",null,"Направление заказчика",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[3]||(l[3]=e=>u.value.customer_type=e),class:(0,h.C4)(["form-select",{invalid:v.value.customer_type}]),onChange:m},[l[13]||(l[13]=(0,n.Lk)("option",{value:"",disabled:""},"Выберите направление",-1)),((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(r,e=>(0,n.Lk)("option",{key:e.value,value:e.value},(0,h.v_)(e.label),9,Yl)),64))],34),[[a.u1,u.value.customer_type]]),v.value.customer_type?((0,n.uX)(),(0,n.CE)("span",Zl,"Выберите направление")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.systema}])},[l[16]||(l[16]=(0,n.Lk)("label",null,"Система",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[4]||(l[4]=e=>u.value.systema=e),class:(0,h.C4)(["form-select",{invalid:v.value.systema}]),onChange:m},[l[15]||(l[15]=(0,n.Lk)("option",{value:"",disabled:""},"— Выберите систему —",-1)),((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(d,e=>(0,n.Lk)("option",{key:e.value,value:e.value},(0,h.v_)(e.label),9,et)),64))],34),[[a.u1,u.value.systema]]),v.value.systema?((0,n.uX)(),(0,n.CE)("span",lt,"Укажите систему")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.profile}])},[l[18]||(l[18]=(0,n.Lk)("label",null,"Профиль",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[5]||(l[5]=e=>u.value.profile=e),class:(0,h.C4)(["form-select",{invalid:v.value.profile}]),onChange:m},[l[17]||(l[17]=(0,n.Lk)("option",{value:"",disabled:""},"— Выберите профиль —",-1)),((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(i,e=>(0,n.Lk)("option",{key:e.value,value:e.value},(0,h.v_)(e.label),9,tt)),64))],34),[[a.u1,u.value.profile]]),v.value.profile?((0,n.uX)(),(0,n.CE)("span",at,"Укажите профиль")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.sqr}])},[l[19]||(l[19]=(0,n.Lk)("label",null,"Площадь",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[6]||(l[6]=e=>u.value.sqr=e),type:"number",step:"0.001",min:"0",class:(0,h.C4)(["form-input",{invalid:v.value.sqr}]),onBlur:m},null,34),[[a.Jo,u.value.sqr,void 0,{number:!0}]]),v.value.sqr?((0,n.uX)(),(0,n.CE)("span",nt,"Введите корректную площадь")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.brigade}])},[l[21]||(l[21]=(0,n.Lk)("label",null,"Бригада",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[7]||(l[7]=e=>u.value.brigade=e),class:(0,h.C4)(["form-select",{invalid:v.value.brigade}]),onChange:m},[l[20]||(l[20]=(0,n.Lk)("option",{value:"",disabled:""},"Выберите значение",-1)),((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(c,e=>(0,n.Lk)("option",{key:e,value:e},(0,h.v_)(e),9,ot)),64))],34),[[a.u1,u.value.brigade]]),v.value.brigade?((0,n.uX)(),(0,n.CE)("span",ut,"Выберите бригаду")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.coefficient}])},[l[22]||(l[22]=(0,n.Lk)("label",null,"Коэффициент",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[8]||(l[8]=e=>u.value.coefficient=e),type:"number",step:"0.01",min:"0",class:(0,h.C4)(["form-input",{invalid:v.value.coefficient}]),onBlur:m},null,34),[[a.Jo,u.value.coefficient,void 0,{number:!0}]]),v.value.coefficient?((0,n.uX)(),(0,n.CE)("span",rt,"Введите коэффициент")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",{class:(0,h.C4)(["form-group",{error:v.value.norm_money}])},[l[23]||(l[23]=(0,n.Lk)("label",null,"Н/руб",-1)),(0,n.Lk)("input",{value:u.value.norm_money,onInput:g,onFocus:b,type:"number",step:"0.01",min:"0",class:(0,h.C4)(["form-input",{invalid:v.value.norm_money}]),onBlur:m},null,42,st),v.value.norm_money?((0,n.uX)(),(0,n.CE)("span",it,"Введите норму в рублях")):(0,n.Q3)("",!0)],2),(0,n.Lk)("div",dt,[(0,n.Lk)("button",{onClick:w,class:"btn-cancel"},"Отмена"),(0,n.Lk)("button",{onClick:y,class:"btn-save",disabled:!k.value}," Сохранить ",8,pt)])])]))}};const vt=(0,y.A)(ct,[["__scopeId","data-v-71257e06"]]);var mt=vt;const kt={key:0,class:"no-data"},yt={key:1,class:"summary-stats"},Lt={class:"summary-table"},_t={key:2,class:"summary-stats"},bt={class:"summary-table"},ht={key:3,class:"summary-stats"},ft={class:"summary-table"},gt={key:4,class:"summary-stats total-summary"},Ct={class:"summary-table"},wt={class:"total-row"},Ft={class:"toggle-section"},Et={key:0,class:"summary-stats detailed-grouping"},xt={class:"summary-table"},Xt={key:0,class:"summary-stats unmatched-grouping"},zt={class:"summary-table"};var Vt={__name:"SummaryStats",props:{products:{type:Array,required:!0}},setup(e){const l=e;function t(e){return(e||"").trim().toLowerCase()}function o(e){const l=e.reduce((e,l)=>(e.count+=parseFloat(l.count)||0,e.sqr+=parseFloat(l.sqr)||0,e.hours+=parseFloat(l.total_time)||0,e.money+=parseFloat(l.norm_money)||0,e),{count:0,sqr:0,hours:0,money:0});return{count:parseFloat(l.count.toFixed(3)),sqr:parseFloat(l.sqr.toFixed(3)),hours:parseFloat(l.hours.toFixed(3)),money:parseFloat(l.money.toFixed(3))}}const u=(0,n.EW)(()=>{const e=l.products,a=e.filter(e=>("window"===e.type||"glyhar"===e.type)&&t(e.systema).includes("х")&&"витраж к двери"!==t(e.type_izd)),n=e.filter(e=>("window"===e.type||"glyhar"===e.type)&&t(e.systema).includes("т")&&"витраж к двери"!==t(e.type_izd)),u=e.filter(e=>"glyhar"===e.type&&"витраж к двери"===t(e.type_izd)),r=[...a,...n,...u],s=e.filter(e=>"door"===e.type&&("1П"===e.type_izd||"1Пт"===e.type_izd)),i=e.filter(e=>"door"===e.type&&("1.5П"===e.type_izd||"1.5Пт"===e.type_izd)),d=e.filter(e=>"door"===e.type&&("2П"===e.type_izd||"2Пт"===e.type_izd)),p=e.filter(e=>"loggia"===e.type),c=e.filter(e=>"ms"===e.type),v=o(a),m=o(n),k=o(r),y=o(u),L=o(p),_=o(c),b=o(s),h=o(i),f=o(d),g=[{type_izd:"Холодные окна",profile:"х",...v},{type_izd:"Теплые окна",profile:"т",...m},{type_izd:"Витраж к двери",profile:"",...y},{type_izd:"Всего окон",profile:"",...k},{type_izd:"Всего 1П дверей",profile:"",...b},{type_izd:"Всего 1.5П дверей",profile:"",...h},{type_izd:"Всего 2П дверей",profile:"",...f}].filter(e=>e.count>0),C=L.count>0?[{type_izd:"Лоджии",profile:"",...L}]:[],w=_.count>0?[{type_izd:"Москитные сетки",profile:"",..._}]:[],F=[k,b,h,f].reduce((e,l)=>({count:e.count+l.count,sqr:e.sqr+l.sqr,hours:e.hours+l.hours,money:e.money+l.money}),{count:0,sqr:0,hours:0,money:0}),E={count:parseFloat(F.count.toFixed(3)),sqr:parseFloat(F.sqr.toFixed(3)),hours:parseFloat(F.hours.toFixed(3)),money:parseFloat(F.money.toFixed(3))};return{windowGroups:g,loggiaGroup:C,mosquitoGroup:w,totalRounded:E}}),r=[{type_izd:"окно гл.",profile:"ах"},{type_izd:"окно гл.",profile:"ат"},{type_izd:"окно гл.",profile:"ш"},{type_izd:"окно гл.",profile:"сх"},{type_izd:"окно гл.",profile:"ст"},{type_izd:"окно пов.-отк.",profile:"ах"},{type_izd:"окно пов.-отк.",profile:"ат"},{type_izd:"окно пов.-отк.",profile:"ст"},{type_izd:"окно пов.-отк.",profile:"сх"},{type_izd:"окно пов.-отк.",profile:"ш"},{type_izd:"1П",profile:"ах"},{type_izd:"1П",profile:"сх"},{type_izd:"1Пт",profile:"ат"},{type_izd:"1Пт",profile:"ст"},{type_izd:"1Пт",profile:"ш"},{type_izd:"1.5П",profile:"ах"},{type_izd:"1.5П",profile:"сх"},{type_izd:"1.5Пт",profile:"ат"},{type_izd:"1.5Пт",profile:"ст"},{type_izd:"1.5Пт",profile:"ш"},{type_izd:"2П",profile:"ах"},{type_izd:"2П",profile:"сх"},{type_izd:"2Пт",profile:"ат"},{type_izd:"2Пт",profile:"ст"},{type_izd:"2Пт",profile:"ш"}];function s(e){const l=e=>{const l=(e.type_izd||"").trim(),t=null==e.profile?"":String(e.profile).trim();return`${l}__${t}`},t=new Set(r.map(e=>{const l=(e.type_izd||"").trim(),t=null==e.profile?"":String(e.profile).trim();return`${l}__${t}`})),a=new Map,n=[];e.forEach(e=>{const o=l(e);if(t.has(o)){a.has(o)||a.set(o,{count:0,sqr:0,hours:0,money:0});const l=a.get(o);l.count+=e.count||0,l.sqr+=e.sqr||0,l.hours+=e.total_time||0,l.money+=e.norm_money||0}else n.push(e)});const o=r.map(e=>{const l=null==e.profile?"":String(e.profile).trim(),t=`${e.type_izd.trim()}__${l}`,n=a.get(t)||{count:0,sqr:0,hours:0,money:0};return{type_izd:e.type_izd,profile:e.profile,count:parseFloat(n.count.toFixed(3)),sqr:parseFloat(n.sqr.toFixed(3)),hours:parseFloat(n.hours.toFixed(3)),money:parseFloat(n.money.toFixed(3))}});return{fixedGroups:o,unmatched:n}}const i=(0,n.EW)(()=>s(l.products)),d=(0,n.EW)(()=>i.value.fixedGroups),p=(0,n.EW)(()=>i.value.unmatched),c=(0,f.KR)(!1),v=e=>{const l={window:"Окно",door:"Дверь",loggia:"Лоджия",ms:"Москитная сетка",glyhar:"Глухое окно"};return l[e]||e};return(e,t)=>((0,n.uX)(),(0,n.CE)(n.FK,null,[l.products.length?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",kt," Нет данных для отображения. ")),u.value.windowGroups.length>0?((0,n.uX)(),(0,n.CE)("div",yt,[t[2]||(t[2]=(0,n.Lk)("h4",null,"Окна и двери",-1)),(0,n.Lk)("table",Lt,[t[1]||(t[1]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Наименование"),(0,n.Lk)("th",null,"Профиль"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Площадь, м²"),(0,n.Lk)("th",null,"Н/час"),(0,n.Lk)("th",null,"Н/руб")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.value.windowGroups,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.type_izd},[(0,n.Lk)("td",null,(0,h.v_)(e.type_izd),1),(0,n.Lk)("td",null,(0,h.v_)(e.profile),1),(0,n.Lk)("td",null,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,(0,h.v_)(e.sqr),1),(0,n.Lk)("td",null,(0,h.v_)(e.hours),1),(0,n.Lk)("td",null,(0,h.v_)(e.money),1)]))),128))])])])):(0,n.Q3)("",!0),u.value.loggiaGroup.length>0?((0,n.uX)(),(0,n.CE)("div",_t,[t[3]||(t[3]=(0,n.Lk)("h4",null,"Лоджии",-1)),(0,n.Lk)("table",bt,[(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.value.loggiaGroup,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.type_izd},[(0,n.Lk)("td",null,(0,h.v_)(e.type_izd),1),(0,n.Lk)("td",null,(0,h.v_)(e.profile),1),(0,n.Lk)("td",null,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,(0,h.v_)(e.sqr),1),(0,n.Lk)("td",null,(0,h.v_)(e.hours),1),(0,n.Lk)("td",null,(0,h.v_)(e.money),1)]))),128))])])])):(0,n.Q3)("",!0),u.value.mosquitoGroup.length>0?((0,n.uX)(),(0,n.CE)("div",ht,[t[4]||(t[4]=(0,n.Lk)("h4",null,"Москитные сетки",-1)),(0,n.Lk)("table",ft,[(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.value.mosquitoGroup,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.type_izd},[(0,n.Lk)("td",null,(0,h.v_)(e.type_izd),1),(0,n.Lk)("td",null,(0,h.v_)(e.profile),1),(0,n.Lk)("td",null,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,(0,h.v_)(e.sqr),1),(0,n.Lk)("td",null,(0,h.v_)(e.hours),1),(0,n.Lk)("td",null,(0,h.v_)(e.money),1)]))),128))])])])):(0,n.Q3)("",!0),u.value.totalRounded.count>0?((0,n.uX)(),(0,n.CE)("div",gt,[t[7]||(t[7]=(0,n.Lk)("h4",null,"Всего за месяц",-1)),(0,n.Lk)("table",Ct,[t[6]||(t[6]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th"),(0,n.Lk)("th"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Площадь, м²"),(0,n.Lk)("th",null,"Н/час"),(0,n.Lk)("th",null,"Н/руб")])],-1)),(0,n.Lk)("tbody",null,[(0,n.Lk)("tr",wt,[t[5]||(t[5]=(0,n.Lk)("td",{colspan:"2"},[(0,n.Lk)("strong",null,"Итого:")],-1)),(0,n.Lk)("td",null,[(0,n.Lk)("strong",null,(0,h.v_)(u.value.totalRounded.count),1)]),(0,n.Lk)("td",null,[(0,n.Lk)("strong",null,(0,h.v_)(u.value.totalRounded.sqr),1)]),(0,n.Lk)("td",null,[(0,n.Lk)("strong",null,(0,h.v_)(u.value.totalRounded.hours),1)]),(0,n.Lk)("td",null,[(0,n.Lk)("strong",null,(0,h.v_)(u.value.totalRounded.money),1)])])])])])):(0,n.Q3)("",!0),(0,n.Lk)("div",Ft,[(0,n.Lk)("button",{onClick:t[0]||(t[0]=e=>c.value=!c.value),class:"btn-toggle"},(0,h.v_)(c.value?"Скрыть детали":"Показать детальную информацию"),1)]),(0,n.bF)(a.eB,{name:"slide"},{default:(0,n.k6)(()=>[c.value&&d.value.length>0?((0,n.uX)(),(0,n.CE)("div",Et,[t[12]||(t[12]=(0,n.Lk)("h4",null,"Детализация по профилям",-1)),(0,n.Lk)("table",xt,[t[8]||(t[8]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Наименование"),(0,n.Lk)("th",null,"Профиль"),(0,n.Lk)("th",null,"Кол-во"),(0,n.Lk)("th",null,"Площадь, м²"),(0,n.Lk)("th",null,"Н/час"),(0,n.Lk)("th",null,"Н/руб")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(d.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:`${e.type_izd}_${e.profile}`},[(0,n.Lk)("td",null,(0,h.v_)(e.type_izd),1),(0,n.Lk)("td",null,(0,h.v_)(e.profile),1),(0,n.Lk)("td",null,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,(0,h.v_)(e.sqr),1),(0,n.Lk)("td",null,(0,h.v_)(e.hours),1),(0,n.Lk)("td",null,(0,h.v_)(e.money),1)]))),128))])]),c.value&&p.value.length>0?((0,n.uX)(),(0,n.CE)("div",Xt,[t[10]||(t[10]=(0,n.Lk)("h4",{style:{color:"#e53e3e"}},"⚠️ Изделия, не попавшие в отчёт",-1)),t[11]||(t[11]=(0,n.Lk)("p",{style:{"font-size":"12px",color:"#e53e3e","margin-bottom":"8px"}}," Эти изделия не соответствуют ни одному из правил группировки. Проверьте написание «Наименование» и «Профиль». ",-1)),(0,n.Lk)("table",zt,[t[9]||(t[9]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Заказ"),(0,n.Lk)("th",null,"Наименование"),(0,n.Lk)("th",null,"Профиль"),(0,n.Lk)("th",null,"Тип")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(p.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id},[(0,n.Lk)("td",null,(0,h.v_)(e.order_num),1),(0,n.Lk)("td",null,(0,h.v_)(e.type_izd),1),(0,n.Lk)("td",null,(0,h.v_)(e.profile),1),(0,n.Lk)("td",null,(0,h.v_)(v(e.type)),1)]))),128))])])])):(0,n.Q3)("",!0)])):(0,n.Q3)("",!0)]),_:1})],64))}};const Ut=(0,y.A)(Vt,[["__scopeId","data-v-5533f081"]]);var Kt=Ut;const It={class:"peo-report"},qt={class:"filters"},Rt={class:"filter-group"},$t={class:"filter-group"},St=["value"],Wt={class:"filter-group"},Jt={class:"type-filters"},Tt=["value"],Ot={class:"checkbox-text"},Nt={class:"table-container"},At={class:"report-table"},Dt=["onClick"];var jt={__name:"FinalNormOrdersList",setup(e){const l=(new Date).getFullYear(),t=(0,f.KR)(l),o=(0,f.KR)((new Date).getMonth()+1),u=(0,f.KR)(""),r=(0,f.KR)(null),s=e=>{r.value={...e}},i=async e=>{try{const l={...e,sqr:parseFloat(e.sqr)||0,norm_money:parseFloat(e.norm_money)||0,coefficient:parseFloat(e.coefficient),total_time:parseFloat(e.total_time)||0,count:parseInt(e.count)||0};await g.A.put(`/api/final/update/${e.id}`,l);const t=b.value.findIndex(l=>l.id===e.id);-1!==t&&(b.value[t]=e),r.value=null,X()}catch(l){console.error("Ошибка сохранения",l)}},d=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],p={assigned:"Сотрудники назначены",final:"Готов"},c=e=>p[e]||e,v=(0,n.EW)(()=>`${t.value}-${String(o.value).padStart(2,"0")}-01`),m=(0,n.EW)(()=>{const e=new Date(t.value,o.value,0),l=String(e.getDate()).padStart(2,"0"),a=String(o.value).padStart(2,"0");return`${t.value}-${a}-${l}`}),k={combined:{label:"Окна и двери",types:["window","door","glyhar"]},loggia:{label:"Лоджии",types:["loggia"]},mosquito_net:{label:"Москитные сетки",types:["ms"]}},y=(0,f.KR)(["combined"]),L=(0,n.EW)(()=>{const e=[];return y.value.forEach(l=>{const t=k[l];t&&e.push(...t.types)}),e}),_=(0,f.KR)([]),b=(0,f.KR)([]),C=(0,n.EW)(()=>{const e=b.value||[],l=[...e].sort((e,l)=>{const t=e.ready_date?new Date(e.ready_date):new Date(0),a=l.ready_date?new Date(l.ready_date):new Date(0),n=a-t;return 0!==n?n:e.id-l.id}),t=new Map;let a=1;for(const n of l)"main"===n.part_type&&t.set(n.id,a++);return l.map(e=>{let l=0;return"main"===e.part_type?l=t.get(e.id)||0:"sub"===e.part_type&&e.parent_product_id&&(l=t.get(e.parent_product_id)||0),{...e,rowNumber:l}})}),w=(0,n.EW)(()=>{const e=L.value;return 0===e.length?[]:C.value.filter(l=>e.includes(l.type))}),F=e=>{const l={window:"Окно",door:"Дверь",loggia:"Лоджия",ms:"Москитная сетка",glyhar:"Глухое окно"};return l[e]||e},E=(e,l)=>{const t=e.employee_value?.[String(l)];return t?parseFloat(t.toFixed(3)):""},x=async()=>{const e=d[o.value-1],l=t.value,a=L.value;let n="Все типы";const u=new Set(["window","door","glyhar"]),r=new Set(a);n=a.length>4?"Все типы":r.size===u.size&&[...u].every(e=>r.has(e))?"Окна":1===r.size&&r.has("loggia")?"Лоджии":1===r.size&&r.has("ms")?"Москитки":[...new Set(a.map(F))].sort().join(", ");const s=new(Hl().Workbook),i=s.addWorksheet(`Отчёт ПЭО - ${e} ${l} ${n}`),p=["№","Спецификация","№ заказа","корп/дил","Заказчик","Вид продукции","Система","Наименование","Профиль","Количество","Площадь","Н/час","Изготовитель","Н/руб"],c=_.value.map(e=>e.name),v=[...p,...c,"Итого"],m=i.addRow(v);m.eachCell(e=>{e.font={bold:!0,size:10},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEEEEEE"}},e.border={style:"thin"}}),w.value.forEach(e=>{const l=[e.rowNumber,e.parent_assembly||"",e.order_num||"не определено",e.customer_type||"не определено",e.customer||"не определено",F(e.type),e.systema||"не определено",e.type_izd||"не определено",e.profile||"не определено",e.count||0,e.sqr||0,e.total_time||0,e.brigade||"не определено",e.norm_money||0],t=_.value.map(l=>{const t=E(e,l.id);return t?parseFloat(t):0}),a=t.reduce((e,l)=>e+l,0),n=a>0?parseFloat(a.toFixed(3)):"",o=_.value.map(l=>{const t=E(e,l.id);return t||""}),u=[...l,...o,n],r=i.addRow(u);a>0&&Math.abs(a-(parseFloat(e.total_time)||0))>.001&&r.eachCell((e,l)=>{l===u.length&&(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFF99"}})}),r.eachCell(e=>{e.font={size:10},e.alignment={vertical:"middle",horizontal:"center"},e.border={style:"thin"},"string"===typeof e.value&&"не определено"===e.value&&(e.font={bold:!0,size:10,color:{argb:"FFFF0000"}})})}),i.addRow([]);const k=w.value;function y(e){return(e||"").trim().toLowerCase()}function b(e){const l=e.reduce((e,l)=>(e.sqr+=parseFloat(l.sqr)||0,e.hours+=parseFloat(l.total_time)||0,e.money+=parseFloat(l.norm_money)||0,e.count+=parseInt(l.count)||0,e),{count:0,sqr:0,hours:0,money:0});return{count:parseFloat(l.count.toFixed(3)),sqr:parseFloat(l.sqr.toFixed(3)),hours:parseFloat(l.hours.toFixed(3)),money:parseFloat(l.money.toFixed(3))}}const h=k.filter(e=>("window"===e.type||"glyhar"===e.type)&&y(e.systema).includes("х")&&"витраж к двери"!==y(e.type_izd)),f=k.filter(e=>("window"===e.type||"glyhar"===e.type)&&y(e.systema).includes("т")&&"витраж к двери"!==y(e.type_izd)),g=k.filter(e=>"glyhar"===e.type&&"витраж к двери"===y(e.type_izd)),C=[...h,...f,...g],x=k.filter(e=>"door"===e.type&&("1П"===e.type_izd||"1Пт"===e.type_izd)),X=k.filter(e=>"door"===e.type&&("1.5П"===e.type_izd||"1.5Пт"===e.type_izd)),z=k.filter(e=>"door"===e.type&&("2П"===e.type_izd||"2Пт"===e.type_izd)),V=b(h),U=b(f),K=b(C),I=b(x),q=b(X),R=b(z),$=b(g),S=[K,I,q,R].reduce((e,l)=>({count:e.count+l.count,sqr:e.sqr+l.sqr,hours:e.hours+l.hours,money:e.money+l.money}),{count:0,sqr:0,hours:0,money:0}),W={count:parseFloat(S.count.toFixed(3)),sqr:parseFloat(S.sqr.toFixed(3)),hours:parseFloat(S.hours.toFixed(3)),money:parseFloat(S.money.toFixed(3))},J=i.addRow(["Сводная статистика"]);J.getCell(1).font={bold:!0,size:14},i.addRow([]);const T=["","","Кол-во","Площадь, м²","Н/час","Н/руб"],O=i.addRow(T);O.eachCell(e=>{e.font={bold:!0},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFDDDDDD"}},e.border={style:"thin"}});const N=(e,l,t)=>{const a=i.addRow([e,"",t.count,t.sqr,t.hours,t.money]);a.eachCell(e=>{e.border={style:"thin"},0===t.count&&0===t.sqr&&0===t.hours&&0===t.money&&(e.font={italic:!0,color:{argb:"FF888888"}})})};N("Холодные окна","",V),N("Теплые окна","",U),N("Витраж к двери","",$),N("Всего окон","",K),N("Всего 1П дверей","",I),N("Всего 1.5П дверей","",q),N("Всего 2П дверей","",R),i.addRow([]);const A=i.addRow(["","ИТОГО:",W.count,W.sqr,W.hours,W.money]);A.eachCell((e,l)=>{l>=3&&(e.font={bold:!0},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFCCFFFF"}})}),i.addRow([]),i.addRow([]);const D=[{type_izd:"окно гл.",profile:"ах"},{type_izd:"окно гл.",profile:"ат"},{type_izd:"окно гл.",profile:"ш"},{type_izd:"окно гл.",profile:"сх"},{type_izd:"окно гл.",profile:"ст"},{type_izd:"окно пов.-отк.",profile:"ах"},{type_izd:"окно пов.-отк.",profile:"ат"},{type_izd:"окно пов.-отк.",profile:"ст"},{type_izd:"окно пов.-отк.",profile:"сх"},{type_izd:"окно пов.-отк.",profile:"ш"},{type_izd:"1П",profile:"ах"},{type_izd:"1П",profile:"сх"},{type_izd:"1Пт",profile:"ат"},{type_izd:"1Пт",profile:"ст"},{type_izd:"1Пт",profile:"ш"},{type_izd:"1.5П",profile:"ах"},{type_izd:"1.5П",profile:"сх"},{type_izd:"1.5Пт",profile:"ат"},{type_izd:"1.5Пт",profile:"ст"},{type_izd:"1.5Пт",profile:"ш"},{type_izd:"2П",profile:"ах"},{type_izd:"2П",profile:"сх"},{type_izd:"2Пт",profile:"ат"},{type_izd:"2Пт",profile:"ст"},{type_izd:"2Пт",profile:"ш"}],j=i.addRow(["Детализация по профилям"]);j.getCell(1).font={bold:!0,size:14},i.addRow([]);const P=["Наименование","Профиль","Кол-во","Площадь","н/час","н/руб"],Q=i.addRow(P);Q.eachCell(e=>{e.font={bold:!0},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFDDDDDD"}},e.border={style:"thin"}});const H={};D.forEach(e=>{const l=`${e.type_izd}__${e.profile}`;H[l]={count:0,sqr:0,hours:0,money:0}}),k.forEach(e=>{const l=`${e.type_izd}__${e.profile}`;if(!H[l])return;const t=H[l];t.count+=parseInt(e.count)||0,t.sqr+=parseFloat(e.sqr)||0,t.hours+=parseFloat(e.total_time)||0,t.money+=parseFloat(e.norm_money)||0}),D.forEach(e=>{const l=`${e.type_izd}__${e.profile}`,t=H[l]||{count:0,sqr:0,hours:0,money:0},a=i.addRow([e.type_izd,e.profile,t.count,parseFloat(t.sqr.toFixed(3)),parseFloat(t.hours.toFixed(3)),parseFloat(t.money.toFixed(3))]);a.eachCell(e=>{e.border={style:"thin"},0===t.count&&0===t.sqr&&0===t.hours&&0===t.money&&(e.font={italic:!0,color:{argb:"FF888888"}})})}),i.columns.forEach(e=>{let l=10;e.eachCell({includeEmpty:!0},e=>{const t=e.value?String(e.value).length:10;t>l&&(l=t)}),e.width=Math.min(l+2,30)});const M=await s.xlsx.writeBuffer(),G=new Blob([M],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),B=URL.createObjectURL(G),Y=document.createElement("a");Y.href=B,Y.download=`peo-report-${l}-${String(o.value).padStart(2,"0")}.xlsx`,Y.click(),URL.revokeObjectURL(B)},X=async()=>{try{const e=new URLSearchParams;L.value.forEach(l=>{e.append("type",l)}),e.append("from",v.value),e.append("to",m.value),e.append("order_num",u.value);const l=await g.A.get(`/api/all_final_order?${e}`);_.value=l.data.employees,b.value=l.data.products}catch(e){console.error("Ошибка загрузки данных:",e)}};return(0,n.sV)(()=>{X()}),(e,l)=>((0,n.uX)(),(0,n.CE)("div",It,[(0,n.Lk)("div",qt,[(0,n.Lk)("div",Rt,[l[5]||(l[5]=(0,n.Lk)("label",{for:"year-select"},"Год",-1)),(0,n.bo)((0,n.Lk)("select",{id:"year-select","onUpdate:modelValue":l[0]||(l[0]=e=>t.value=e),onChange:X,class:"filter-select"},[((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)([2023,2024,2025,2026,2027],e=>(0,n.Lk)("option",{key:e},(0,h.v_)(e),1)),64))],544),[[a.u1,t.value]])]),(0,n.Lk)("div",$t,[l[6]||(l[6]=(0,n.Lk)("label",{for:"month-select"},"Месяц",-1)),(0,n.bo)((0,n.Lk)("select",{id:"month-select","onUpdate:modelValue":l[1]||(l[1]=e=>o.value=e),onChange:X,class:"filter-select"},[((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(d,(e,l)=>(0,n.Lk)("option",{key:l+1,value:l+1},(0,h.v_)(e),9,St)),64))],544),[[a.u1,o.value]])]),(0,n.Lk)("div",Wt,[l[7]||(l[7]=(0,n.Lk)("label",{for:"order-input"},"№ заказа",-1)),(0,n.bo)((0,n.Lk)("input",{id:"order-input",type:"text","onUpdate:modelValue":l[2]||(l[2]=e=>u.value=e),placeholder:"",onInput:X,class:"filter-input"},null,544),[[a.Jo,u.value]])]),(0,n.Lk)("div",Jt,[((0,n.uX)(),(0,n.CE)(n.FK,null,(0,n.pI)(k,(e,t)=>(0,n.Lk)("label",{key:t,class:"checkbox-label"},[(0,n.bo)((0,n.Lk)("input",{type:"checkbox",value:t,"onUpdate:modelValue":l[3]||(l[3]=e=>y.value=e),onChange:X,class:"checkbox-input"},null,40,Tt),[[a.lH,y.value]]),(0,n.Lk)("span",Ot,(0,h.v_)(e.label),1)])),64))])]),(0,n.bF)(Kt,{products:w.value},null,8,["products"]),r.value?((0,n.uX)(),(0,n.Wv)(mt,{key:0,product:r.value,employees:_.value,onClose:i,onCancel:l[4]||(l[4]=e=>r.value=null)},null,8,["product","employees"])):(0,n.Q3)("",!0),(0,n.Lk)("div",Nt,[(0,n.Lk)("table",At,[(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[l[8]||(l[8]=(0,n.Lk)("th",null,"Статус",-1)),l[9]||(l[9]=(0,n.Lk)("th",null,"Позиция",-1)),l[10]||(l[10]=(0,n.Lk)("th",null,"№",-1)),l[11]||(l[11]=(0,n.Lk)("th",null,"Спецификация",-1)),l[12]||(l[12]=(0,n.Lk)("th",null,"№ заказа",-1)),l[13]||(l[13]=(0,n.Lk)("th",null,"корп/дил",-1)),l[14]||(l[14]=(0,n.Lk)("th",null,"Заказчик",-1)),l[15]||(l[15]=(0,n.Lk)("th",null,"Вид продукции",-1)),l[16]||(l[16]=(0,n.Lk)("th",null,"Система",-1)),l[17]||(l[17]=(0,n.Lk)("th",null,"Наименование",-1)),l[18]||(l[18]=(0,n.Lk)("th",null,"Профиль",-1)),l[19]||(l[19]=(0,n.Lk)("th",null,"Кол-во",-1)),l[20]||(l[20]=(0,n.Lk)("th",null,"Площадь",-1)),l[21]||(l[21]=(0,n.Lk)("th",null,"Н/час",-1)),l[22]||(l[22]=(0,n.Lk)("th",null,"Изготовитель",-1)),l[23]||(l[23]=(0,n.Lk)("th",null,"Н/руб",-1)),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(_.value,e=>((0,n.uX)(),(0,n.CE)("th",{key:e.id,class:"employee-col"},(0,h.v_)(e.name),1))),128))])]),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(w.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id,onClick:()=>s(e),class:"clickable-row"},[(0,n.Lk)("td",null,[(0,n.Lk)("span",{class:(0,h.C4)(`status-badge status-${e.status}`)},(0,h.v_)(c(e.status)),3)]),(0,n.Lk)("td",null,(0,h.v_)(e.position),1),(0,n.Lk)("td",null,(0,h.v_)(e.rowNumber),1),(0,n.Lk)("td",null,(0,h.v_)(e.parent_assembly),1),(0,n.Lk)("td",null,(0,h.v_)(e.order_num),1),(0,n.Lk)("td",{class:(0,h.C4)({"profile-empty":""===e.customer_type,"cell-warning":""===e.customer_type})},(0,h.v_)(e.customer_type),3),(0,n.Lk)("td",null,(0,h.v_)(e.customer),1),(0,n.Lk)("td",null,(0,h.v_)(F(e.type)),1),(0,n.Lk)("td",{class:(0,h.C4)({"profile-empty":""===e.systema,"cell-warning":""===e.systema})},(0,h.v_)(e.systema),3),(0,n.Lk)("td",{class:(0,h.C4)({"profile-empty":""===e.type_izd,"cell-warning":""===e.type_izd})},(0,h.v_)(e.type_izd),3),(0,n.Lk)("td",{class:(0,h.C4)({"profile-empty":""===e.profile,"cell-warning":""===e.profile})},(0,h.v_)(e.profile),3),(0,n.Lk)("td",null,(0,h.v_)(e.count),1),(0,n.Lk)("td",null,(0,h.v_)(e.sqr),1),(0,n.Lk)("td",null,(0,h.v_)(e.total_time),1),(0,n.Lk)("td",{class:(0,h.C4)({"profile-empty":""===e.brigade,"cell-warning":""===e.brigade})},(0,h.v_)(e.brigade),3),(0,n.Lk)("td",null,(0,h.v_)(e.norm_money),1),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(_.value,l=>((0,n.uX)(),(0,n.CE)("td",{key:l.id,class:"employee-col"},(0,h.v_)(E(e,l.id)),1))),128))],8,Dt))),128))])])]),(0,n.Lk)("div",{class:"actions"},[(0,n.Lk)("button",{onClick:x,class:"btn-export"}," Экспорт в Excel ")])]))}};const Pt=(0,y.A)(jt,[["__scopeId","data-v-1b6cd7a1"]]);var Qt=Pt;const Ht={class:"admin-panel"},Mt={class:"admin-nav"};var Gt={__name:"AdminPanel",setup(e){return(e,l)=>{const t=(0,n.g2)("router-link"),a=(0,n.g2)("router-view");return(0,n.uX)(),(0,n.CE)("div",Ht,[l[3]||(l[3]=(0,n.Lk)("h1",null,"Админка сервиса нормирования",-1)),(0,n.Lk)("nav",Mt,[(0,n.bF)(t,{to:"/admin/templates"},{default:(0,n.k6)(()=>l[0]||(l[0]=[(0,n.eW)("Шаблоны")])),_:1,__:[0]}),l[2]||(l[2]=(0,n.eW)(" | ")),(0,n.bF)(t,{to:"/admin/peo"},{default:(0,n.k6)(()=>l[1]||(l[1]=[(0,n.eW)("ПЭО")])),_:1,__:[1]})]),(0,n.bF)(a)])}}};const Bt=(0,y.A)(Gt,[["__scopeId","data-v-88b56988"]]);var Yt=Bt;const Zt={class:"admin-templates"},ea={key:0},la={key:1,class:"error"},ta={key:2,class:"templates-table"},aa={key:3};var na={__name:"AdminTemplates",setup(e){const l=(0,f.KR)({}),t=(0,f.KR)(!1),a=(0,f.KR)(null),o=(0,b.rd)();async function u(){t.value=!0,a.value=null;try{const e=await fetch("/api/admin/all_templates");if(!e.ok)throw new Error(`HTTP ${e.status}`);l.value=await e.json()}catch(e){console.error("Ошибка загрузки шаблонов:",e),a.value=e.message}finally{t.value=!1}}function r(){o.push("/admin/templates/new")}return(0,n.sV)(()=>{u()}),(e,o)=>{const u=(0,n.g2)("router-link");return(0,n.uX)(),(0,n.CE)("div",Zt,[o[2]||(o[2]=(0,n.Lk)("h2",null,"Шаблоны изделий",-1)),(0,n.Lk)("button",{onClick:r,class:"btn btn-primary"},"Создать шаблон"),t.value?((0,n.uX)(),(0,n.CE)("div",ea,"Загрузка...")):a.value?((0,n.uX)(),(0,n.CE)("div",la,"Ошибка: "+(0,h.v_)(a.value),1)):(0,n.Q3)("",!0),l.value.Template&&l.value.Template.length?((0,n.uX)(),(0,n.CE)("table",ta,[o[1]||(o[1]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Код"),(0,n.Lk)("th",null,"Категория"),(0,n.Lk)("th",null,"Название"),(0,n.Lk)("th",null,"Действия")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(l.value.Template,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id},[(0,n.Lk)("td",null,(0,h.v_)(e.code),1),(0,n.Lk)("td",null,(0,h.v_)(e.category),1),(0,n.Lk)("td",null,(0,h.v_)(e.name),1),(0,n.Lk)("td",null,[(0,n.bF)(u,{to:`/admin/templates/edit/${e.code}`},{default:(0,n.k6)(()=>o[0]||(o[0]=[(0,n.eW)("Редактировать")])),_:2,__:[0]},1032,["to"])])]))),128))])])):t.value||l.value.Template&&0!==l.value.Template.length?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",aa," Шаблоны не найдены "))])}}};const oa=(0,y.A)(na,[["__scopeId","data-v-d7f1de8e"]]);var ua=oa;const ra={class:"template-edit"},sa={key:0},ia=["onUpdate:modelValue"],da=["onUpdate:modelValue"],pa={class:"template-edit"},ca={key:0},va=["onUpdate:modelValue"],ma=["onUpdate:modelValue"],ka={class:"template-edit"},ya={key:0};var La={__name:"AdminEditDataPeo",setup(e){const l=(0,f.KR)(!1),t=(0,f.KR)([]),o=(0,f.KR)([]),u=(0,f.KR)({name:"",is_active:!1});async function r(){const e=await fetch("/api/admin/coefficient");if(!e.ok)throw new Error("Ошибка коэффициентов");return await e.json()}async function s(){const e=await fetch("/api/admin/employees");if(!e.ok)throw new Error("Ошибка сотрудников");return await e.json()}async function i(){try{const e=await fetch("/api/admin/coefficient/update",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.value)});if(!e.ok)throw new Error(`HTTP ${e.status}`)}catch(e){console.log("Коэффициенты не обновлены",e)}}async function d(){try{const e=await fetch("/api/admin/employees/update",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o.value)});if(!e.ok)throw new Error(`HTTP ${e.status}`)}catch(e){console.log("Коэффициенты не обновлены",e)}}async function p(){try{const e=await fetch("/api/admin/employees/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u.value)});if(!e.ok)throw new Error(`HTTP ${e.status}`)}catch(e){console.log("Новый сотрудник не сохранен",e)}}return(0,n.sV)(async()=>{l.value=!0;try{const[e,l]=await Promise.all([r(),s()]);t.value=e,o.value=l}catch(e){console.log("Ошибка получения данных",e)}finally{l.value=!1}}),(e,r)=>((0,n.uX)(),(0,n.CE)(n.FK,null,[(0,n.Lk)("div",ra,[r[4]||(r[4]=(0,n.Lk)("h2",null,"Редактирование коэффициентов ПЭО",-1)),l.value?((0,n.uX)(),(0,n.CE)("div",sa,"Загрузка...")):((0,n.uX)(),(0,n.CE)("form",{key:1,onSubmit:(0,a.D$)(i,["prevent"]),class:"operations-table"},[(0,n.Lk)("table",null,[r[2]||(r[2]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Тип изделия"),(0,n.Lk)("th",null,"Коэффициент"),(0,n.Lk)("th",null,"Использовать")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id},[(0,n.Lk)("td",null,(0,h.v_)(e.type),1),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{min:"0",step:"0.001","onUpdate:modelValue":l=>e.coefficient=l},null,8,ia),[[a.Jo,e.coefficient,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"checkbox","onUpdate:modelValue":l=>e.is_active=l},null,8,da),[[a.lH,e.is_active]])])]))),128))])]),r[3]||(r[3]=(0,n.Lk)("div",null,[(0,n.Lk)("button",{type:"submit"},"Сохранить")],-1))],32))]),(0,n.Lk)("div",pa,[r[7]||(r[7]=(0,n.Lk)("h2",null,"Редактирование сотрудников ПЭО",-1)),l.value?((0,n.uX)(),(0,n.CE)("div",ca,"Загрузка...")):((0,n.uX)(),(0,n.CE)("form",{key:1,onSubmit:(0,a.D$)(d,["prevent"]),class:"operations-table"},[(0,n.Lk)("table",null,[r[5]||(r[5]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"ID"),(0,n.Lk)("th",null,"Имя"),(0,n.Lk)("th",null,"Работает или нет")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.value,e=>((0,n.uX)(),(0,n.CE)("tr",{key:e.id},[(0,n.Lk)("td",null,(0,h.v_)(e.id),1),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.name=l},null,8,va),[[a.Jo,e.name]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"checkbox","onUpdate:modelValue":l=>e.is_active=l},null,8,ma),[[a.lH,e.is_active]])])]))),128))])]),r[6]||(r[6]=(0,n.Lk)("div",null,[(0,n.Lk)("button",{type:"submit"},"Сохранить")],-1))],32))]),(0,n.Lk)("div",ka,[r[10]||(r[10]=(0,n.Lk)("h2",null,"Добавить сотрудника",-1)),l.value?((0,n.uX)(),(0,n.CE)("div",ya,"Загрузка...")):((0,n.uX)(),(0,n.CE)("form",{key:1,onSubmit:(0,a.D$)(p,["prevent"]),class:"operations-table"},[(0,n.Lk)("table",null,[r[8]||(r[8]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",null,"Имя"),(0,n.Lk)("th",null,"Работает или нет")])],-1)),(0,n.Lk)("tbody",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":r[0]||(r[0]=e=>u.value.name=e)},null,512),[[a.Jo,u.value.name]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"checkbox","onUpdate:modelValue":r[1]||(r[1]=e=>u.value.is_active=e)},null,512),[[a.lH,u.value.is_active]])])])])]),r[9]||(r[9]=(0,n.Lk)("div",null,[(0,n.Lk)("button",{type:"submit"},"Сохранить")],-1))],32))])],64))}};const _a=La;var ba=_a;const ha={class:"template-edit"},fa={key:0},ga={class:"form-checkbox"},Ca={class:"operations-table"},wa=["onUpdate:modelValue"],Fa=["onUpdate:modelValue"],Ea=["onUpdate:modelValue"],xa=["onUpdate:modelValue"],Xa=["onUpdate:modelValue"],za=["onUpdate:modelValue"],Va=["onClick"],Ua={class:"form-actions"};var Ka={__name:"AdminTemplateEdit",setup(e){const l=(0,b.lq)(),t=(0,b.rd)(),o=(0,f.KR)({code:"",name:"",category:"",systema:"",type_izd:"",profile:"",is_active:1,operations:[],rules:null,head_name:""}),u=(0,f.KR)(!1);async function r(e){u.value=!0;try{const l=await fetch(`/api/admin/template?code=${e}`);if(!l.ok)throw new Error(`HTTP ${l.status}`);o.value=await l.json()}catch(l){console.error("Ошибка загрузки шаблона:",l),alert("Не удалось загрузить шаблон"),t.push("/admin/templates")}finally{u.value=!1}}function s(){o.value.operations.push({label:"",name:"",count:0,value:0,minutes:0,group:"",type:"number",required:!0})}function i(e){o.value.operations.splice(e,1)}async function d(){try{const e={...o.value,operations:o.value.operations},a=await fetch(`/api/admin/template/update/${l.params.code}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP ${a.status}`);alert("Шаблон сохранён"),t.push("/admin/templates")}catch(e){console.error("Ошибка сохранения:",e),alert("Не удалось сохранить шаблон")}}return(0,n.sV)(()=>{const e=l.params.code;e?r(e):s()}),(e,l)=>{const t=(0,n.g2)("router-link");return(0,n.uX)(),(0,n.CE)("div",ha,[l[19]||(l[19]=(0,n.Lk)("h2",null,"Редактирование шаблона",-1)),u.value?((0,n.uX)(),(0,n.CE)("div",fa,"Загрузка...")):((0,n.uX)(),(0,n.CE)("form",{key:1,onSubmit:(0,a.D$)(d,["prevent"])},[(0,n.Lk)("div",null,[l[7]||(l[7]=(0,n.Lk)("label",null,"Название для шаблона:",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>o.value.name=e),required:""},null,512),[[a.Jo,o.value.name]])]),(0,n.Lk)("div",ga,[l[8]||(l[8]=(0,n.Lk)("label",{for:"is_active"},"Использовать шаблон",-1)),(0,n.bo)((0,n.Lk)("input",{type:"checkbox",id:"is_active","onUpdate:modelValue":l[1]||(l[1]=e=>o.value.is_active=e)},null,512),[[a.lH,o.value.is_active]])]),(0,n.Lk)("div",null,[l[10]||(l[10]=(0,n.Lk)("label",null,"Категория:",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[2]||(l[2]=e=>o.value.category=e)},l[9]||(l[9]=[(0,n.Lk)("option",{value:"window"},"Окно",-1),(0,n.Lk)("option",{value:"door"},"Дверь",-1),(0,n.Lk)("option",{value:"glyhar"},"Гляхарь",-1)]),512),[[a.u1,o.value.category]])]),(0,n.Lk)("div",null,[l[11]||(l[11]=(0,n.Lk)("label",null,"Система(т-теплая,х-холодная, писать т или х):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[3]||(l[3]=e=>o.value.systema=e)},null,512),[[a.Jo,o.value.systema]])]),(0,n.Lk)("div",null,[l[12]||(l[12]=(0,n.Lk)("label",null,"Тип изделия(окно гл., окно пов.-отк., 1П, 1.5П,2П,1Пт,1.5Пт,2Пт):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[4]||(l[4]=e=>o.value.type_izd=e)},null,512),[[a.Jo,o.value.type_izd]])]),(0,n.Lk)("div",null,[l[13]||(l[13]=(0,n.Lk)("label",null,"Профиль(сх,ст,ах,ат,ш):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[5]||(l[5]=e=>o.value.profile=e)},null,512),[[a.Jo,o.value.profile]])]),(0,n.Lk)("div",null,[l[14]||(l[14]=(0,n.Lk)("label",null,"Заголовок для страницы печати(изготовление П-образ системы Алютех):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[6]||(l[6]=e=>o.value.head_name=e)},null,512),[[a.Jo,o.value.head_name]])]),l[18]||(l[18]=(0,n.Lk)("h3",null,"Операции",-1)),(0,n.Lk)("table",Ca,[l[15]||(l[15]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",{class:"col-label"},"Название"),(0,n.Lk)("th",null,"Название транскрипт"),(0,n.Lk)("th",null,"Количество"),(0,n.Lk)("th",null,"Значения(н/ч)"),(0,n.Lk)("th",null,"Значения(н/м)"),(0,n.Lk)("th",null,"Группа"),(0,n.Lk)("th")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.value.operations,(e,l)=>((0,n.uX)(),(0,n.CE)("tr",{key:l},[(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.label=l},null,8,wa),[[a.Jo,e.label]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.name=l},null,8,Fa),[[a.Jo,e.name]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"1",min:"0","onUpdate:modelValue":l=>e.count=l},null,8,Ea),[[a.Jo,e.count,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"0.001",min:"0","onUpdate:modelValue":l=>e.value=l},null,8,xa),[[a.Jo,e.value,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"0.001",min:"0","onUpdate:modelValue":l=>e.minutes=l},null,8,Xa),[[a.Jo,e.minutes,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.group=l},null,8,za),[[a.Jo,e.group]])]),(0,n.Lk)("td",null,[(0,n.Lk)("button",{type:"button",onClick:e=>i(l)},"Удалить",8,Va)])]))),128))])]),(0,n.Lk)("button",{type:"button",onClick:s,class:"btn"},"+ Добавить операцию"),(0,n.Lk)("div",Ua,[l[17]||(l[17]=(0,n.Lk)("button",{type:"submit"},"Сохранить",-1)),(0,n.bF)(t,{to:"/admin/templates",class:"btn btn-outline"},{default:(0,n.k6)(()=>l[16]||(l[16]=[(0,n.eW)("Отмена")])),_:1,__:[16]})])],32))])}}};const Ia=(0,y.A)(Ka,[["__scopeId","data-v-f9d67704"]]);var qa=Ia;const Ra={class:"template-edit"},$a={key:0},Sa={class:"form-checkbox"},Wa={class:"operations-table"},Ja=["onUpdate:modelValue"],Ta=["onUpdate:modelValue"],Oa=["onUpdate:modelValue"],Na=["onUpdate:modelValue"],Aa=["onUpdate:modelValue"],Da=["onUpdate:modelValue"],ja=["onClick"],Pa={class:"form-actions"};var Qa={__name:"AdminTemplateCreate",setup(e){const l=(0,b.rd)(),t=(0,f.KR)({code:"",name:"",category:"",systema:"",type_izd:"",profile:"",is_active:1,operations:[],rules:null,head_name:""}),o=(0,f.KR)(!1);function u(){t.value.operations.push({label:"",name:"",count:0,value:0,minutes:0,group:"",type:"number",required:!1})}function r(e){t.value.operations.splice(e,1)}async function s(){try{const e={...t.value,operations:t.value.operations};console.log("PAYYY",e);const a=await fetch("/api/admin/template/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP ${a.status}`);alert("Шаблон сохранён"),l.push("/admin/templates")}catch(e){console.error("Ошибка сохранения:",e),alert("Не удалось сохранить шаблон")}}return(0,n.sV)(()=>{u()}),(e,l)=>{const i=(0,n.g2)("router-link");return(0,n.uX)(),(0,n.CE)("div",Ra,[l[21]||(l[21]=(0,n.Lk)("h2",null,"Создание нового шаблона",-1)),o.value?((0,n.uX)(),(0,n.CE)("div",$a,"Загрузка...")):((0,n.uX)(),(0,n.CE)("form",{key:1,onSubmit:(0,a.D$)(s,["prevent"])},[(0,n.Lk)("div",null,[l[8]||(l[8]=(0,n.Lk)("label",null,"Код шаблона",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[0]||(l[0]=e=>t.value.code=e),required:""},null,512),[[a.Jo,t.value.code]])]),(0,n.Lk)("div",null,[l[9]||(l[9]=(0,n.Lk)("label",null,"Название для шаблона:",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[1]||(l[1]=e=>t.value.name=e),required:""},null,512),[[a.Jo,t.value.name]])]),(0,n.Lk)("div",Sa,[l[10]||(l[10]=(0,n.Lk)("label",{for:"is_active"},"Использовать шаблон",-1)),(0,n.bo)((0,n.Lk)("input",{type:"checkbox",id:"is_active","onUpdate:modelValue":l[2]||(l[2]=e=>t.value.is_active=e)},null,512),[[a.lH,t.value.is_active]])]),(0,n.Lk)("div",null,[l[12]||(l[12]=(0,n.Lk)("label",null,"Категория:",-1)),(0,n.bo)((0,n.Lk)("select",{"onUpdate:modelValue":l[3]||(l[3]=e=>t.value.category=e)},l[11]||(l[11]=[(0,n.Lk)("option",{value:"window"},"Окно",-1),(0,n.Lk)("option",{value:"door"},"Дверь",-1),(0,n.Lk)("option",{value:"glyhar"},"Гляхарь",-1)]),512),[[a.u1,t.value.category]])]),(0,n.Lk)("div",null,[l[13]||(l[13]=(0,n.Lk)("label",null,"Система(т-теплая,х-холодная, писать т или х):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[4]||(l[4]=e=>t.value.systema=e)},null,512),[[a.Jo,t.value.systema]])]),(0,n.Lk)("div",null,[l[14]||(l[14]=(0,n.Lk)("label",null,"Тип изделия(окно гл., окно пов.-отк., 1П, 1.5П,2П,1Пт,1.5Пт,2Пт):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[5]||(l[5]=e=>t.value.type_izd=e)},null,512),[[a.Jo,t.value.type_izd]])]),(0,n.Lk)("div",null,[l[15]||(l[15]=(0,n.Lk)("label",null,"Профиль(сх,ст,ах,ат,ш):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[6]||(l[6]=e=>t.value.profile=e)},null,512),[[a.Jo,t.value.profile]])]),(0,n.Lk)("div",null,[l[16]||(l[16]=(0,n.Lk)("label",null,"Заголовок для страницы печати(изготовление П-образ системы Алютех):",-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l[7]||(l[7]=e=>t.value.head_name=e)},null,512),[[a.Jo,t.value.head_name]])]),l[20]||(l[20]=(0,n.Lk)("h3",null,"Операции",-1)),(0,n.Lk)("table",Wa,[l[17]||(l[17]=(0,n.Lk)("thead",null,[(0,n.Lk)("tr",null,[(0,n.Lk)("th",{class:"col-label"},"Название"),(0,n.Lk)("th",null,"Название транскрипт"),(0,n.Lk)("th",null,"Количество"),(0,n.Lk)("th",null,"Значения(н/ч)"),(0,n.Lk)("th",null,"Значения(н/м)"),(0,n.Lk)("th",null,"Группа"),(0,n.Lk)("th")])],-1)),(0,n.Lk)("tbody",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(t.value.operations,(e,l)=>((0,n.uX)(),(0,n.CE)("tr",{key:l},[(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.label=l},null,8,Ja),[[a.Jo,e.label]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.name=l},null,8,Ta),[[a.Jo,e.name]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"1",min:"0","onUpdate:modelValue":l=>e.count=l},null,8,Oa),[[a.Jo,e.count,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"0.001",min:"0","onUpdate:modelValue":l=>e.value=l},null,8,Na),[[a.Jo,e.value,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{type:"number",step:"0.001",min:"0","onUpdate:modelValue":l=>e.minutes=l},null,8,Aa),[[a.Jo,e.minutes,void 0,{number:!0}]])]),(0,n.Lk)("td",null,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":l=>e.group=l},null,8,Da),[[a.Jo,e.group]])]),(0,n.Lk)("td",null,[(0,n.Lk)("button",{type:"button",onClick:e=>r(l)},"Удалить",8,ja)])]))),128))])]),(0,n.Lk)("button",{type:"button",onClick:u,class:"btn"},"+ Добавить операцию"),(0,n.Lk)("div",Pa,[l[19]||(l[19]=(0,n.Lk)("button",{type:"submit"},"Сохранить",-1)),(0,n.bF)(i,{to:"/admin/templates",class:"btn btn-outline"},{default:(0,n.k6)(()=>l[18]||(l[18]=[(0,n.eW)("Отмена")])),_:1,__:[18]})])],32))])}}};const Ha=(0,y.A)(Qa,[["__scopeId","data-v-1609ef96"]]);var Ma=Ha;const Ga=[{path:"/orders/order-norm/:id",name:"OrdersDetails",component:Fe,props:!0},{path:"/orders/order-norm/form/:id",name:"FormPagePeo",component:me},{path:"/norm/order-norm/print/:id",name:"FormPrintNorm",component:Qe},{path:"/orders",component:K},{path:"/norm/orders",name:"NormOrdersList",component:sl},{path:"/norm/orders/order-norm/edit/:id",name:"EditNormOrder",component:El},{path:"/norm/workers/:id",name:"AssignWorkers",component:Pl},{path:"/final/orders",name:"FinalNormOrdersList",component:Qt},{path:"/admin",component:Yt,children:[{path:"",redirect:"admin/templates"},{path:"templates",component:ua},{path:"peo",component:ba}]},{path:"/admin/templates/edit/:code",name:"AdminTemplateEdit",component:qa},{path:"/admin/templates/new",name:"AdminTemplateCreate",component:Ma}],Ba=(0,b.aE)({history:(0,b.LA)(),routes:Ga});var Ya=Ba;const Za=(0,a.Ef)(_);Za.use(Ya),Za.mount("#app")}},l={};function t(a){var n=l[a];if(void 0!==n)return n.exports;var o=l[a]={exports:{}};return e[a].call(o.exports,o,o.exports,t),o.exports}t.m=e,function(){var e=[];t.O=function(l,a,n,o){if(!a){var u=1/0;for(d=0;d<e.length;d++){a=e[d][0],n=e[d][1],o=e[d][2];for(var r=!0,s=0;s<a.length;s++)(!1&o||u>=o)&&Object.keys(t.O).every(function(e){return t.O[e](a[s])})?a.splice(s--,1):(r=!1,o<u&&(u=o));if(r){e.splice(d--,1);var i=n();void 0!==i&&(l=i)}}return l}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[a,n,o]}}(),function(){t.n=function(e){var l=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(l,{a:l}),l}}(),function(){t.d=function(e,l){for(var a in l)t.o(l,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:l[a]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,l){return Object.prototype.hasOwnProperty.call(e,l)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){t.p="/"}(),function(){var e={524:0};t.O.j=function(l){return 0===e[l]};var l=function(l,a){var n,o,u=a[0],r=a[1],s=a[2],i=0;if(u.some(function(l){return 0!==e[l]})){for(n in r)t.o(r,n)&&(t.m[n]=r[n]);if(s)var d=s(t)}for(l&&l(a);i<u.length;i++)o=u[i],t.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return t.O(d)},a=self["webpackChunkfrontend"]=self["webpackChunkfrontend"]||[];a.forEach(l.bind(null,0)),a.push=l.bind(null,a.push.bind(a))}();var a=t.O(void 0,[504],function(){return t(7610)});a=t.O(a)})();
//# sourceMappingURL=app.62c3677a.js.map